<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KinoStats</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root {
            --bg-main: #14181f;
            --bg-card: #1b1f26;
            --bg-input: #232830;
            --border: #2d333b;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6e7681;
            --accent: #2ecc71;
            --accent-hover: #27ae60;
            --accent-dim: rgba(46, 204, 113, 0.15);
            --info: #60a5fa;
            --info-dim: rgba(96, 165, 250, 0.15);
            --danger: #e74c3c;
            --radius: 16px;
            --radius-lg: 24px;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-glow: 0 8px 24px rgba(46, 204, 113, 0.15);
            --transition-bounce: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition-smooth: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .light {
            --bg-main: #f6f8fa;
            --bg-card: #ffffff;
            --bg-input: #f0f6fc;
            --border: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #59636e;
            --text-muted: #8c959f;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-glow: 0 8px 24px rgba(35, 134, 54, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-main);
            color: var(--text-secondary);
            font-family: var(--tg-theme-font-family, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif);
            font-size: clamp(14px, 4vw, 16px);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: clamp(24px, 8vw, 36px);
            transition: background var(--transition-smooth), color var(--transition-smooth);
            overflow-x: hidden;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: clamp(16px, 4vw, 20px);
            margin: 0 clamp(12px, 3.5vw, 16px) clamp(12px, 3vw, 16px);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), background var(--transition-smooth), border-color var(--transition-smooth);
        }

        @media (hover: hover) {
            .card.hoverable:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 32px rgba(0,0,0,0.2);
                border-color: var(--accent);
            }
            .clickable:hover { background: var(--bg-input); }
            .li-clickable:hover { transform: translateX(6px); background: var(--bg-input); }
            .tab:not(.on):hover { background: var(--bg-input); color: var(--text-primary); }
            .yr:not(.on):hover { background: var(--bg-input); color: var(--text-primary); }
            .stat.clickable:hover { transform: translateY(-3px); box-shadow: var(--shadow-glow); border-color: var(--accent); }
            .hist-item.clickable:hover .hist-poster { transform: scale(1.05) rotate(2deg); }
        }

        .clickable { cursor: pointer; transition: transform var(--transition-bounce), background var(--transition-smooth), box-shadow var(--transition-smooth), border-color var(--transition-smooth); }
        .clickable:active { transform: scale(0.95); background: var(--bg-input) !important; }

        .header { display: flex; align-items: center; justify-content: space-between; padding: clamp(16px, 5vw, 24px) clamp(16px, 4vw, 20px) clamp(8px, 2vw, 12px); }
        .header-left { display: flex; align-items: center; gap: clamp(12px, 3vw, 16px); }
        .avatar {
            width: clamp(48px, 13vw, 56px); height: clamp(48px, 13vw, 56px); border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-input), var(--border));
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(20px, 6vw, 24px); font-weight: 800; color: var(--text-primary); flex-shrink: 0;
            overflow: hidden; border: 2px solid var(--bg-card); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform var(--transition-bounce);
        }
        .avatar:active { transform: scale(0.9) rotate(-10deg); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .header-name { font-size: clamp(20px, 6vw, 24px); font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; line-height: 1.2; }
        .header-sub  { font-size: clamp(12px, 3.5vw, 14px); color: var(--accent); font-weight: 600; margin-top: 2px; }
        
        .theme-btn {
            width: clamp(36px, 10vw, 44px); height: clamp(36px, 10vw, 44px); border-radius: 50%;
            background: var(--bg-input); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-primary); transition: transform var(--transition-bounce), background var(--transition-smooth);
            box-shadow: var(--shadow-sm);
        }
        .theme-btn:active { transform: scale(0.85) rotate(45deg); }
        .theme-btn .icon { font-size: clamp(18px, 5vw, 22px); line-height: 1; }

        .tabs { display: flex; gap: clamp(8px, 2vw, 12px); padding: clamp(8px, 2vw, 12px) clamp(16px, 4vw, 20px) clamp(8px, 2vw, 12px); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); flex-shrink: 0; padding: clamp(8px, 2.5vw, 12px) clamp(16px, 4vw, 20px); border-radius: 12px;
            font-size: clamp(14px, 3.8vw, 16px); font-weight: 700; white-space: nowrap;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-muted); cursor: pointer; transition: all var(--transition-bounce);
        }
        .tab .icon { font-size: clamp(16px, 4.5vw, 20px); line-height: 1; }
        .tab.on { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
        .tab:not(.on):active { transform: scale(0.92); }

        .years { display: flex; gap: clamp(6px, 1.5vw, 8px); padding: clamp(4px, 1vw, 8px) clamp(16px, 4vw, 20px) clamp(12px, 3vw, 16px); overflow-x: auto; scrollbar-width: none; }
        .years::-webkit-scrollbar { display: none; }
        .yr {
            flex-shrink: 0; padding: clamp(6px, 2vw, 8px) clamp(12px, 3.5vw, 16px); border-radius: 10px;
            font-size: clamp(13px, 3.5vw, 15px); font-weight: 700;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-muted); cursor: pointer; transition: all var(--transition-bounce);
        }
        .yr.on { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); transform: scale(1.05); }
        .yr:not(.on):active { transform: scale(0.92); }

        .label {
            display: flex; align-items: center; gap: clamp(6px, 2vw, 8px);
            font-size: clamp(12px, 3.5vw, 14px); font-weight: 800; text-transform: uppercase;
            letter-spacing: 1px; color: var(--text-secondary); padding: clamp(16px, 4vw, 20px) clamp(16px, 4vw, 20px) clamp(8px, 2vw, 12px);
        }
        .label .icon { font-size: clamp(16px, 4.5vw, 18px); line-height: 1; color: var(--accent); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(12px, 3vw, 16px); padding: 0 clamp(16px, 4vw, 20px) clamp(16px, 4vw, 20px); }
        .stat {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-input)); border: 1px solid var(--border);
            border-radius: var(--radius); padding: clamp(16px, 4vw, 20px); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        .stat::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); opacity: 0; transition: opacity var(--transition-smooth); }
        .stat.clickable:hover::before { opacity: 1; }
        
        .stat-icon  { font-size: clamp(24px, 7vw, 28px); line-height: 1; margin-bottom: clamp(10px, 3vw, 12px); color: var(--text-primary); transition: transform var(--transition-bounce); }
        .stat.clickable:hover .stat-icon { transform: scale(1.1) rotate(5deg); color: var(--accent); }
        
        .stat-val   { font-size: clamp(24px, 6.5vw, 32px); font-weight: 900; color: var(--text-primary); line-height: 1.1; letter-spacing: -0.5px; }
        .stat-lbl   { font-size: clamp(11px, 3vw, 13px); color: var(--text-muted); font-weight: 600; margin-top: clamp(4px, 1.5vw, 6px); }
        .stat-sub   { font-size: clamp(12px, 3.2vw, 14px); color: var(--accent); margin-top: clamp(4px, 1.5vw, 6px); font-weight: 700; display: inline-flex; align-items: center; gap: 4px; background: var(--accent-dim); padding: 2px 8px; border-radius: 10px; width: fit-content; }
        
        .stat.clickable::after {
            content: ''; position: absolute; top: clamp(16px, 4vw, 20px); right: clamp(16px, 4vw, 20px);
            width: clamp(8px, 2.5vw, 12px); height: clamp(8px, 2.5vw, 12px);
            border-top: 2.5px solid var(--text-muted); border-right: 2.5px solid var(--text-muted);
            transform: rotate(45deg); opacity: 0.5; transition: border-color var(--transition-smooth), transform var(--transition-bounce);
        }
        .stat.clickable:hover::after { border-color: var(--accent); transform: rotate(45deg) translate(2px, -2px); opacity: 1; }

        .g-row { margin-bottom: clamp(12px, 3.5vw, 16px); }
        .g-hdr { display: flex; justify-content: space-between; font-size: clamp(13px, 3.5vw, 15px); font-weight: 700; margin-bottom: clamp(6px, 2vw, 8px); }
        .g-name { color: var(--text-primary); }
        .g-time { color: var(--text-muted); font-variant-numeric: tabular-nums; }
        .g-track { height: clamp(6px, 2vw, 8px); background: var(--bg-input); border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .g-fill  { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--accent), var(--info)); transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .g-fill::after { content:''; position: absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .li { display: flex; align-items: center; justify-content: space-between; padding: clamp(12px, 3.5vw, 16px) 0; border-bottom: 1px dashed var(--border); }
        .li:last-child { border: none; }
        .li-clickable {
            padding: clamp(10px, 3vw, 14px) clamp(12px, 3.5vw, 16px);
            margin: 4px calc(-1 * clamp(12px, 3.5vw, 16px)) 0;
            border-radius: 12px;
            border-bottom: none !important;
            transition: all var(--transition-smooth);
        }
        .li-l { display: flex; align-items: center; gap: clamp(12px, 3vw, 16px); min-width: 0; flex: 1; }
        .li-r { font-size: clamp(14px, 4vw, 16px); font-weight: 800; color: var(--text-primary); flex-shrink: 0; margin-left: 12px; text-align: right; font-variant-numeric: tabular-nums; }
        .li-rank { 
            font-size: clamp(14px, 4vw, 16px); 
            font-weight: 800; 
            color: var(--text-secondary); 
            width: clamp(24px, 6vw, 28px); 
            text-align: center; 
            flex-shrink: 0; 
            opacity: 0.8;
        }
        .li-name { display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); font-size: clamp(14px, 4vw, 16px); font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .li-sub  { font-size: clamp(12px, 3.2vw, 14px); color: var(--text-muted); margin-top: 4px; font-weight: 500; }

        .hm { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: clamp(1px, 0.3vw, 2px); width: 100%; }
        .hc { 
            width: 100%; aspect-ratio: 1 / 1; border-radius: 15%; background: var(--bg-input); 
            transition: transform var(--transition-bounce), background var(--transition-smooth), box-shadow var(--transition-smooth);
            cursor: crosshair; position: relative;
        }
        @media (hover: hover) { .hc:hover { transform: scale(1.6); z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border-radius: 10%; } }
        .hc:active { transform: scale(1.6); z-index: 10; border-radius: 10%; }
        
        .h1 { background: rgba(35, 134, 54, 0.3); } 
        .h2 { background: rgba(35, 134, 54, 0.6); } 
        .h3 { background: rgba(35, 134, 54, 0.85); } 
        .h4 { background: #39d353; box-shadow: 0 0 6px rgba(57, 211, 83, 0.3); }
        
        .hm-leg { display: flex; align-items: center; gap: 6px; justify-content: flex-end; margin-top: clamp(12px, 3.5vw, 16px); font-size: clamp(10px, 2.8vw, 12px); color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .hm-leg .hc { width: clamp(10px, 3vw, 12px); height: clamp(10px, 3vw, 12px); border-radius: 15%; cursor: default; }
        .hm-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .hm-days {
            display: grid;
            grid-template-rows: repeat(7, 1fr);
            gap: clamp(1px, 0.3vw, 2px);
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            padding-top: 2px;
        }

        .hm-days span {
            height: 100%;
            display: flex;
            align-items: center;
        }

        .chart-box { position: relative; width: 100%; height: 220px; }

        .cmp { display: flex; justify-content: space-between; align-items: center; padding: clamp(10px, 3vw, 12px) 0; border-bottom: 1px dashed var(--border); }
        .cmp:last-child { border: none; }
        .cmp-lb { font-size: clamp(13px, 3.5vw, 15px); color: var(--text-secondary); font-weight: 700; display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); }
        .cmp-vs { display: flex; gap: clamp(12px, 3vw, 16px); align-items: center; }
        .cmp-v  { font-size: clamp(14px, 4vw, 16px); font-weight: 800; text-align: right; min-width: clamp(40px, 11vw, 48px); font-variant-numeric: tabular-nums; }
        .cmp-you { color: var(--accent); }
        .cmp-grp { color: var(--info); }
        .cmp-d  { font-size: clamp(11px, 3vw, 13px); font-weight: 800; padding: clamp(4px, 1vw, 6px) clamp(8px, 2vw, 10px); border-radius: 8px; min-width: 50px; text-align: center; }
        .d-up   { background: var(--accent-dim); color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
        .d-dn   { background: rgba(248, 81, 73, 0.15); color: var(--danger); box-shadow: inset 0 0 0 1px var(--danger); }
        .d-eq   { background: var(--bg-input); color: var(--text-muted); }

        .mb { display: flex; align-items: center; gap: clamp(10px, 3vw, 12px); margin-bottom: clamp(12px, 3.5vw, 16px); }
        .mb-n { font-size: clamp(13px, 3.5vw, 15px); font-weight: 700; color: var(--text-primary); width: clamp(70px, 20vw, 90px); text-align: right; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mb-t { flex: 1; height: clamp(8px, 2.5vw, 10px); background: var(--bg-input); border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .mb-f { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--info), #a371f7); transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mb-c { font-size: clamp(12px, 3.2vw, 14px); font-weight: 800; color: var(--text-muted); width: clamp(32px, 9vw, 40px); flex-shrink: 0; text-align: right; }

        .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: clamp(32px, 9vw, 48px) clamp(16px, 4vw, 20px); color: var(--text-muted); font-size: clamp(14px, 4vw, 16px); font-weight: 600; text-align: center; }
        .empty .icon { font-size: clamp(36px, 10vw, 48px); line-height: 1; margin-bottom: clamp(12px, 3.5vw, 16px); opacity: 0.3; }

        .loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: opacity 0.4s ease; }
        .light .loader { background: rgba(246, 248, 250, 0.8); }
        .spinner { width: clamp(32px, 9vw, 48px); height: clamp(32px, 9vw, 48px); border: 4px solid var(--bg-input); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .sec { display: none; opacity: 0; transition: opacity var(--transition-smooth); }
        .sec.vis { display: block; opacity: 1; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        @keyframes slideInUp {
            0% { opacity: 0; transform: translateY(20px) scale(0.97); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes slideInRight {
            0% { opacity: 0; transform: translateX(-15px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .anim-item { animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both; }
        .anim-list-item { animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }

        svg { width: 1em; height: 1em; vertical-align: -0.125em; display: inline-block; flex-shrink: 0; fill: currentColor; }
        
        .hist-item { display: flex; gap: clamp(12px, 3.5vw, 16px); padding: clamp(12px, 3.5vw, 16px) clamp(16px, 4vw, 20px); border-bottom: 1px solid var(--border); transition: background var(--transition-smooth); }
        .hist-item:last-child { border: none; }
        .hist-poster { width: clamp(48px, 14vw, 60px); height: clamp(72px, 21vw, 90px); border-radius: 8px; object-fit: cover; background: var(--bg-input); flex-shrink: 0; border: 1px solid var(--border); transition: transform var(--transition-bounce); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .hist-info { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .hist-title { font-size: clamp(15px, 4.2vw, 18px); font-weight: 800; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; margin-bottom: 2px; }
        .hist-orig { font-size: clamp(12px, 3.2vw, 14px); color: var(--text-muted); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
        .hist-meta { font-size: clamp(12px, 3.2vw, 14px); color: var(--text-secondary); display: flex; gap: clamp(8px, 2.5vw, 12px); align-items: center; flex-wrap: wrap; font-weight: 600; }
        .hist-badge { background: var(--bg-input); padding: clamp(2px, 0.5vw, 4px) clamp(6px, 1.5vw, 8px); border-radius: 6px; font-size: clamp(11px, 3vw, 13px); font-weight: 800; color: var(--text-primary); border: 1px solid var(--border); letter-spacing: 0.5px; }
        .rating-badge { display: inline-flex; align-items: center; gap: 4px; color: var(--accent); font-weight: 800; font-size: clamp(12px, 3.2vw, 14px); background: var(--accent-dim); padding: clamp(2px, 0.5vw, 4px) clamp(6px, 1.5vw, 8px); border-radius: 6px; }
        .rating-badge.show-lvl { color: var(--text-primary); background: var(--bg-input); }
        .rating-badge svg { font-size: clamp(14px, 3.8vw, 16px); margin-top: -2px; }
        
        /* Utility for glowing text */
        .glow-text { text-shadow: 0 0 12px rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>

    <div id="app" class="hidden">
        <div class="header">
            <div class="header-left">
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="header-name glow-text" id="user-name">Загрузка…</div>
                    <div class="header-sub" id="period-label"></div>
                </div>
            </div>
            <button class="theme-btn" id="theme-btn" onclick="toggleTheme()"></button>
        </div>

        <div class="tabs" id="main-tabs">
            <button class="tab on" data-tab="personal" onclick="mainTab('personal')">
                <div class="icon" id="ic-user"></div>Личная
            </button>
            <button class="tab" data-tab="group" onclick="mainTab('group')">
                <div class="icon" id="ic-users"></div>Группа
            </button>
        </div>

        <div class="years" id="years"></div>

        <div class="sec vis" id="sec-personal">
            <div class="label"><div class="icon" id="ic-dash"></div>Обзор</div>
            <div class="grid">
                <div class="stat anim-item clickable" style="animation-delay: 0.05s" onclick="openHistory('all')">
                    <div class="stat-icon" id="ic-time"></div>
                    <div class="stat-val" id="s-time">—</div>
                    <div class="stat-lbl">Время просмотра</div>
                    <div class="stat-sub" id="s-views"></div>
                </div>
                <div class="stat anim-item" style="animation-delay: 0.1s">
                    <div class="stat-icon" id="ic-cal"></div>
                    <div class="stat-val" id="s-act">0%</div>
                    <div class="stat-lbl">Активность</div>
                    <div class="stat-sub" id="s-daily" style="background: var(--info-dim); color: var(--info)"></div>
                </div>
                <div class="stat anim-item clickable" style="animation-delay: 0.15s" onclick="openHistory('episodes')">
                    <div class="stat-icon" id="ic-tv"></div>
                    <div class="stat-val" id="s-ep">0</div>
                    <div class="stat-lbl">Эпизодов</div>
                    <div class="stat-sub" id="s-ser" style="background: rgba(163, 113, 247, 0.15); color: #a371f7"></div>
                </div>
                <div class="stat anim-item clickable" style="animation-delay: 0.2s" onclick="openHistory('movies')">
                    <div class="stat-icon" id="ic-film"></div>
                    <div class="stat-val" id="s-mov">0</div>
                    <div class="stat-lbl">Фильмов</div>
                    <div class="stat-sub" id="s-uni" style="background: rgba(210, 153, 34, 0.15); color: #d29922"></div>
                </div>
            </div>

            <div class="card hoverable anim-item" style="animation-delay: 0.25s">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:clamp(16px, 4vw, 20px)">
                    <span style="font-size:clamp(15px, 4vw, 18px);font-weight:800;color:var(--text-primary);display:flex;align-items:center;gap:8px">
                        <div class="icon" style="font-size:clamp(18px, 5vw, 22px);line-height:1;color:var(--info)" id="ic-chart"></div>Динамика
                    </span>
                </div>
                <div class="chart-box"><canvas id="c-monthly"></canvas></div>
            </div>

            <div class="card hoverable anim-item" style="animation-delay: 0.3s">
                <div style="font-size:clamp(15px, 4vw, 18px);font-weight:800;color:var(--text-primary);margin-bottom:clamp(16px, 4vw, 20px)">Дни недели</div>
                <div class="chart-box" style="height:180px"><canvas id="c-weekday"></canvas></div>
            </div>

            <div class="card hoverable anim-item" style="animation-delay: 0.35s">
                <div style="font-size:clamp(15px, 4vw, 18px);font-weight:800;color:var(--text-primary);margin-bottom:clamp(16px, 4vw, 20px);display:flex;align-items:center;gap:8px">
                    <div class="icon" style="font-size:clamp(18px, 5vw, 22px);line-height:1;color:#f85149" id="ic-flame"></div>Интенсивность
                </div>
                <div id="heatmaps-wrapper"></div>
                <div class="hm-leg">
                    <span>Меньше</span>
                    <div class="hc"></div><div class="hc h1"></div><div class="hc h2"></div><div class="hc h3"></div><div class="hc h4"></div>
                    <span>Больше</span>
                </div>
            </div>

            <div class="label"><div class="icon" id="it-gen"></div>Жанры</div>
            <div class="card hoverable anim-item" style="animation-delay: 0.1s; margin-bottom: clamp(12px, 3vw, 16px);">
                <div class="chart-box" style="height:240px;"><canvas id="c-genre"></canvas></div>
            </div>

            <div class="label"><div class="icon" style="color: #d29922;" id="it-act"></div>Актёры</div>
            <div class="card hoverable anim-item" style="animation-delay: 0.15s;" id="actors-box"></div>

            <div class="label"><div class="icon" style="color: #388bfd;" id="it-cou"></div>Страны</div>
            <div class="card hoverable anim-item" style="animation-delay: 0.2s;" id="countries-box"></div>

            <div class="label"><div class="icon" style="color: #a371f7;" id="it-bin"></div>Марафоны</div>
            <div class="card hoverable anim-item" style="animation-delay: 0.25s;" id="binges-box"></div>
        </div>

        <div class="sec" id="sec-group"><div id="group-root"></div></div>

        <div class="sec" id="sec-history">
            <div class="header" style="padding-bottom: 0;">
                <button onclick="closeHistory()" class="tab clickable" style="background:var(--bg-input); color:var(--text-primary); margin-bottom:clamp(12px, 3.5vw, 16px); display:inline-flex;">
                    <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right:6px;"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> Назад
                </button>
            </div>
            <div class="label" style="padding-top:0;"><div class="icon" id="ic-hist-type"></div><span id="hist-title"></span></div>
            <div id="hist-list" style="padding: 0 clamp(12px, 3vw, 16px) clamp(24px, 6vw, 36px);"></div>
        </div>
    </div>

<script>
const Icons = {
    moon: '<svg viewBox="0 0 512 512"><path d="M264 480A232 232 0 0132 248c0-94 54-178.28 137.61-214.67a16 16 0 0121.06 21.06C181.07 76.43 176 97.43 176 120c0 110.28 89.72 200 200 200 22.57 0 43.57-5.07 65.61-14.67a16 16 0 0121.06 21.06C426.28 410 342 480 264 480z"/></svg>',
    sun: '<svg viewBox="0 0 512 512"><path d="M256 118a22 22 0 01-22-22V48a22 22 0 0144 0v48a22 22 0 01-22 22zM256 486a22 22 0 01-22-22v-48a22 22 0 0144 0v48a22 22 0 01-22 22zM369.14 164.86a22 22 0 01-15.56-37.55l33.94-33.94a22 22 0 0131.11 31.11l-33.94 33.94a21.93 21.93 0 01-15.55 6.44zM108.92 425.08a22 22 0 01-15.55-37.56l33.94-33.94a22 22 0 1131.11 31.11l-33.94 33.94a21.94 21.94 0 01-15.56 6.45zM464 278h-48a22 22 0 010-44h48a22 22 0 010 44zM96 278H48a22 22 0 010-44h48a22 22 0 010 44zM403.08 425.08a21.94 21.94 0 01-15.56-6.45l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.55 37.56zM142.86 164.86a21.93 21.93 0 01-15.55-6.44l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.56 37.55zM256 358a102 102 0 11102-102 102.12 102.12 0 01-102 102z"/></svg>',
    user: '<svg viewBox="0 0 512 512"><path d="M256 288c79.53 0 144-64.47 144-144S335.53 0 256 0 112 64.47 112 144s64.47 144 144 144zm128 32h-24.1c-30.83 18.66-67.43 28-103.9 28s-73.07-9.34-103.9-28H128c-70.69 0-128 57.31-128 128v56c0 13.25 10.75 24 24 24h464c13.25 0 24-10.75 24-24v-56c0-70.69-57.31-128-128-128z"/></svg>',
    users: '<svg viewBox="0 0 512 512"><path d="M336 256c-20.56 0-40.44-5.06-58.26-14.34-14.73 21-36.42 36.63-61.64 43.68C236.41 298.54 263.26 304 290.5 304h25.4C379.79 304 432 356.21 432 419.86v43.21a20.89 20.89 0 0019.2 20.93h41.6a20.9 20.9 0 0019.2-20.93v-43.21C512 344.21 433.79 256 336 256zM336 224a104 104 0 10-104-104 104.12 104.12 0 00104 104zM201.5 272c-63.53 0-115.2 51.68-115.2 115.21v43.86A20.94 20.94 0 00105.5 452h192a20.94 20.94 0 0019.2-20.93v-43.86C316.7 323.68 265.03 272 201.5 272zM201.5 240A112 112 0 1089.5 128a112.12 112.12 0 00112 112z"/></svg>',
    dash: '<svg viewBox="0 0 512 512"><path d="M200 48H88a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V88a40 40 0 00-40-40zM424 48H312a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V88a40 40 0 00-40-40zM200 272H88a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V312a40 40 0 00-40-40zM424 272H312a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V312a40 40 0 00-40-40z"/></svg>',
    time: '<svg viewBox="0 0 512 512"><path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm96 240h-96a16 16 0 01-16-16V128a16 16 0 0132 0v128h80a16 16 0 010 32z"/></svg>',
    cal: '<svg viewBox="0 0 512 512"><path d="M416 64h-16V48a16 16 0 00-32 0v16H144V48a16 16 0 00-32 0v16H96a64 64 0 00-64 64v320a64 64 0 0064 64h320a64 64 0 0064-64V128a64 64 0 00-64-64zm16 384a16 16 0 01-16 16H96a16 16 0 01-16-16V208h352z"/></svg>',
    tv: '<svg viewBox="0 0 512 512"><path d="M447.86 384H64.14A48.2 48.2 0 0116 335.86V128.14A48.2 48.2 0 0164.14 80h383.72A48.2 48.2 0 01496 128.14v207.72A48.2 48.2 0 01447.86 384zM256 416c-48.87 0-98.39 12-113 18.52-5.71 2.54-9 8.24-9 14.28a15.82 15.82 0 0015.42 16.63c33.09-1.28 70.84-1.43 106.58-1.43 36.31 0 74.45.15 106.58 1.43A15.82 15.82 0 00378 448.8c0-6-3.29-11.74-9-14.28C354.39 428 304.87 416 256 416z"/></svg>',
    film: '<svg viewBox="0 0 512 512"><path d="M436 48H76a44.05 44.05 0 00-44 44v328a44.05 44.05 0 0044 44h360a44.05 44.05 0 0044-44V92a44.05 44.05 0 00-44-44zM136 400H88v-48h48zm0-96H88v-48h48zm0-96H88v-48h48zm0-96H88V64h48zm288 288h-48v-48h48zm0-96h-48v-48h48zm0-96h-48v-48h48zm0-96h-48V64h48z"/></svg>',
    chart: '<svg viewBox="0 0 512 512"><path d="M480 384H64V48a16 16 0 00-32 0v352a16 16 0 0016 16h432a16 16 0 000-32z"/><path d="M112 320h48a16 16 0 0016-16V144a16 16 0 00-16-16h-48a16 16 0 00-16 16v160a16 16 0 0016 16zM240 320h48a16 16 0 0016-16V208a16 16 0 00-16-16h-48a16 16 0 00-16 16v96a16 16 0 0016 16zM368 320h48a16 16 0 0016-16V80a16 16 0 00-16-16h-48a16 16 0 00-16 16v224a16 16 0 0016 16z"/></svg>',
    masks: '<svg viewBox="0 0 512 512"><path d="M374.83 148.5c-20.73-35.41-61.35-43.1-99.28-40.35-6.61.48-12.78 1.15-18.42 1.94-39.77 5.61-75.14-3.23-95.64-38.38A180.78 180.78 0 00122 55.45c-29.35.53-53.72 26-58.84 55.51-14.88 85.54-6.39 173.23 23.32 240.59 13.9 31.5 35.79 53 58 53h.46c24.23-1 43.17-18.4 56.44-48 11.23-25.07 16-53.64 21.05-83.33 3.6-21.05 7.42-43.34 16.89-63.56-5.71-1.39-11.41-2.92-17.15-4.43-15.65-4.14-25-18-20.89-33.65a25.4 25.4 0 0132.88-18.19c23.07 6.4 51.5 15.67 76.5 33.15 48.74 34.11 36.85 91.22 36.85 91.22a201.81 201.81 0 0040.35-71.39c4.27-14.28.32-41.56-13.03-57.87zM102.58 205.15a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42zm86 16.51a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42z"/><path d="M449.62 189.65c-20-43.43-63.85-61.27-111-61.27-23.36 0-46.73 4-66.36 8.78-22.39-17-54-28-80.12-35-15.48-4.2-24.93 9.77-20.89 25.4a25.4 25.4 0 0032.88 18.2c6-1.51 11.75-2.73 17.51-3.66a220.4 220.4 0 01-13 46 179.88 179.88 0 0113.1 19.34c38 52.32 94.61 74.32 153.37 74.32a188 188 0 0021.2-1.22c-.64.12-.52 0-1.11.15a133 133 0 01-17.7 21c-5.26 5-11.45 9.76-18.72 14.18-12.78 7.78-26.24 13-39.73 15.35A177.36 177.36 0 00346.59 455c14.25 31 35.08 51 57.82 51h.51c23.59-1 42.14-18.74 55-48 29.83-67.75 38.64-155.8 23.37-241.64-5.35-29.62-28.77-44.62-33.67-26.71zm-136.2 30.68a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42zm86 0a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42z"/></svg>',
    star: '<svg viewBox="0 0 512 512"><path d="M480 208H328L256 48l-72 160H32l128 104-48 152 144-104 144 104-48-152 128-104z"/></svg>',
    globe: '<svg viewBox="0 0 512 512"><path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm89.15 112.59A151.78 151.78 0 01366 240H288v-87.35a265.41 265.41 0 0157.15 8zM256 80.59A231.87 231.87 0 01283.47 152H228.53A231.87 231.87 0 01256 80.59zM166.85 160.59A265.41 265.41 0 01224 152.65V240h-78A151.78 151.78 0 01166.85 160.59zM80.58 240H146a256.32 256.32 0 000 32H80.58a176 176 0 010-32zm86.27 111.41A151.78 151.78 0 01146 272h78v87.35a265.41 265.41 0 01-57.15-7.94zM256 431.41A231.87 231.87 0 01228.53 360h54.94A231.87 231.87 0 01256 431.41zM345.15 351.41A265.41 265.41 0 01288 359.35V272h78A151.78 151.78 0 01345.15 351.41zM431.42 272H366a256.32 256.32 0 000-32h65.42a176 176 0 010 32z"/></svg>',
    bolt: '<svg viewBox="0 0 512 512"><path d="M312 32h-110a18 18 0 00-17.74 21l32 188H152a18.3 18.3 0 00-14.86 28.92l160 216a18 18 0 0031.57-12.78l-23-189.14H360a18.3 18.3 0 0015-28.84L215 72h97a18 18 0 000-36z"/></svg>',
    flame: '<svg viewBox="0 0 512 512"><path d="M313.29 82.26c-11.42-30.82-50.62-31-62.29.35C227.18 146.42 160 178.68 160 256c0 53 43 96 96 96s96-43 96-96c0-67.62-54-106.82-38.71-173.74zM256 320c-17.64 0-32-14.36-32-32 0-33.15 28.57-55 42-83.39 12 25.15 22 50.18 22 83.39 0 17.64-14.36 32-32 32z"/><path d="M255.8 48c-42.54 0-82.68 20.31-112 54.34-31 36-47.8 84.34-47.8 135.59 0 114.69 93.31 208.07 208 208.07S512 352.62 512 237.93C512 119 407.41 48 255.8 48zm0 366c-88.22 0-160-71.78-160-160 0-41.6 13.92-80.49 40.23-112.5C160.7 171.84 200.56 150 240 150c18.52 0 35.1 4.54 48 13 41.52-32.55 80-28 80 75 0 88.22-71.78 160-160 160z"/></svg>',
    check: '<svg viewBox="0 0 512 512"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29l-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg>'
};

function i(id, name) { const el = document.getElementById(id); if (el) el.innerHTML = Icons[name]; }
document.addEventListener("DOMContentLoaded", () => {
    i('ic-user', 'user'); i('ic-users', 'users'); i('ic-dash', 'dash');
    i('ic-time', 'time'); i('ic-cal', 'cal'); i('ic-tv', 'tv'); i('ic-film', 'film');
    i('ic-chart', 'chart'); i('ic-flame', 'flame');
    i('it-gen', 'masks'); i('it-act', 'star'); i('it-cou', 'globe'); i('it-bin', 'bolt');
});

const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

let D = null, curYear = null, isDark = true;
let chM = null, chW = null, chG = null;

function toggleTheme() {
    isDark = !isDark;
    document.body.classList.toggle('light', !isDark);
    document.getElementById('theme-btn').innerHTML = isDark ? Icons.moon : Icons.sun;
    localStorage.setItem('kt', isDark ? 'd' : 'l');
    if (D) renderCharts();
}
(function initTheme() {
    if (localStorage.getItem('kt') === 'l') { isDark = false; document.body.classList.add('light'); }
    document.addEventListener("DOMContentLoaded", () => document.getElementById('theme-btn').innerHTML = isDark ? Icons.moon : Icons.sun);
})();

function cc() {
    const t = isDark ? 'rgba(229, 231, 235, .8)' : 'rgba(31, 35, 40, .8)';
    const g = isDark ? 'rgba(255, 255, 255, .05)' : 'rgba(0, 0, 0, .05)';
    const b = isDark ? '#2d333b' : '#d0d7de';
    return { 
        t, 
        g, 
        b, 
        a: '#2ecc71', 
        ab: isDark ? 'rgba(46, 204, 113, .2)' : 'rgba(46, 204, 113, .15)', 
        i: '#60a5fa', 
        ib: isDark ? 'rgba(96, 165, 250, .2)' : 'rgba(96, 165, 250, .15)' 
    };
}

async function load(year) {
    if (year === undefined || year === null) year = curYear;
    curYear = year;
    document.getElementById('loader').classList.remove('hidden');
    try {
        const p = year && year !== 'all' ? { period_type:'year', period_value: year } : { period_type:'year', period_value: 0 };
        const r = await fetch('/api/webapp/detailed_stats/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...p, init_data: tg?.initData||'' }) });
        const j = await r.json();
        if (!r.ok || j.error) { console.error('API error:', j); alert('Ошибка: '+(j.error||'Неизвестная')); return; }
        D = j;
        render();
    } catch(e) { console.error('Load error:', e); alert('Ошибка сети'); }
    finally { 
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').classList.add('hidden'), 400);
        document.getElementById('app').classList.remove('hidden'); 
    }
}

function plural(n, forms) {
    let n10 = Math.abs(n) % 10;
    let n100 = Math.abs(n) % 100;
    if (n100 >= 11 && n100 <= 14) return forms[2];
    if (n10 === 1) return forms[0];
    if (n10 >= 2 && n10 <= 4) return forms[1];
    return forms[2];
}

function render() {
    if (!D?.meta) return;
    const n = D.meta.name || 'Пользователь';
    document.getElementById('user-name').textContent = n;
    
    const u = tg?.initDataUnsafe?.user;
    const avEl = document.getElementById('avatar');
    if (u && u.photo_url) {
        avEl.innerHTML = `<img src="${u.photo_url}" alt="A">`;
    } else {
        avEl.textContent = n.charAt(0).toUpperCase();
    }

    document.getElementById('period-label').textContent = D.summary?.period_label || '';

    renderYears();

    const s = D.summary || {};
    const vViews = s.total_views || 0;
    const vEp = s.total_episodes || 0;
    const vMov = s.total_movies || 0;
    const vSer = s.unique_series || 0;
    const vUni = s.unique_movies || 0;

    document.getElementById('s-time').textContent  = s.duration_display || '0';
    document.getElementById('s-views').textContent = vViews + ' ' + plural(vViews, ['просмотр', 'просмотра', 'просмотров']);
    document.getElementById('s-act').textContent   = (s.activity_percent||0) + '%';
    document.getElementById('s-daily').textContent = '~' + (s.daily_average_min||0) + ' мин/день';
    
    document.getElementById('s-ep').textContent = vEp;
    document.getElementById('s-ep').nextElementSibling.textContent = plural(vEp, ['Эпизод', 'Эпизода', 'Эпизодов']);
    
    document.getElementById('s-ser').textContent = vSer + ' ' + plural(vSer, ['сериал', 'сериала', 'сериалов']);
    
    document.getElementById('s-mov').textContent = vMov;
    document.getElementById('s-mov').nextElementSibling.textContent = plural(vMov, ['Фильм', 'Фильма', 'Фильмов']);

    if ((s.total_movies || 0) === (s.unique_movies || 0)) {
        document.getElementById('s-uni').innerHTML = '&nbsp;';
    } else {
        document.getElementById('s-uni').textContent = vUni + ' ' + plural(vUni, ['уникальный', 'уникальных', 'уникальных']);
    }

    renderHeatmap();
    renderCharts();
    
    fillList('actors-box', D.actors, Icons.star, ['просмотр', 'просмотра', 'просмотров'], 'actors');
    fillList('countries-box', D.countries, Icons.globe, ['просмотр', 'просмотра', 'просмотров'], 'countries');
    fillBinges();
    
    renderGroup();
}

function renderYears() {
    const c = document.getElementById('years');
    const yrs = D.meta?.years || [];
    if (curYear && curYear !== 'all' && yrs.length && !yrs.includes(curYear)) {
        curYear = yrs[0];
    }
    let h = '<button class="yr clickable" onclick="pickYear(\'all\')">Всё время</button>';
    yrs.forEach(y => { h += `<button class="yr clickable" onclick="pickYear(${y})">${y}</button>`; });
    c.innerHTML = h;
    markYear();
}
function markYear() {
    document.querySelectorAll('#years .yr').forEach(b => {
        const v = b.textContent.trim();
        const isAll = !curYear || curYear === 'all';
        b.classList.toggle('on', isAll ? v === 'Всё время' : String(curYear) === v);
    });
}
window.pickYear = y => { curYear = y; markYear(); load(y === 'all' ? 'all' : y); };

function renderHeatmap() {
    const el = document.getElementById('heatmaps-wrapper'); 
    el.innerHTML = '';
    
    if (!D.heatmap?.length) { 
        el.innerHTML = `<div class="empty"><div class="icon">${Icons.cal}</div>Выберите год</div>`; 
        return; 
    }
    
    const fragment = document.createDocumentFragment();
    const dayLabels = ['Пн', '', 'Ср', '', 'Пт', '', 'Вс'];
    
    D.heatmap.forEach((hItem, index) => {
        const yr = hItem.year;
        const data = hItem.data;
        const offset = (new Date(yr, 0, 1).getDay() + 6) % 7;
        
        const totalCells = offset + data.length;
        const totalColumns = Math.ceil(totalCells / 7);
        
        const block = document.createElement('div');
        if (index > 0) block.style.marginTop = 'clamp(16px, 4vw, 20px)';
        
        if (D.heatmap.length > 1) {
            const title = document.createElement('div');
            title.style.fontSize = 'clamp(13px, 3.5vw, 15px)';
            title.style.fontWeight = '800';
            title.style.color = 'var(--text-muted)';
            title.style.marginBottom = 'clamp(6px, 2vw, 8px)';
            title.textContent = yr;
            block.appendChild(title);
        }
        
        const wrapper = document.createElement('div');
        wrapper.className = 'hm-wrapper';

        const daysCol = document.createElement('div');
        daysCol.className = 'hm-days';
        dayLabels.forEach(lbl => {
            const s = document.createElement('span');
            s.textContent = lbl;
            daysCol.appendChild(s);
        });
        wrapper.appendChild(daysCol);
        
        const container = document.createElement('div');
        container.style.width = '100%';
        container.style.overflow = 'hidden';
        
        const hm = document.createElement('div');
        hm.className = 'hm';
        hm.style.gridTemplateColumns = `repeat(${totalColumns}, 1fr)`;
        
        for (let i = 0; i < offset; i++) { 
            const d = document.createElement('div'); 
            d.className = 'hc'; 
            d.style.opacity = '0';
            d.style.pointerEvents = 'none';
            hm.appendChild(d); 
        }
        
        data.forEach(v => { 
            const d = document.createElement('div'); 
            d.className = 'hc' + (v ? ' h' + v : ''); 
            hm.appendChild(d); 
        });
        
        container.appendChild(hm);
        wrapper.appendChild(container);
        block.appendChild(wrapper);
        fragment.appendChild(block);
    });
    
    el.appendChild(fragment);
}

function fillList(id, items, ico, unit, categoryKey) {
    const el = document.getElementById(id);
    if (!items?.length) { el.innerHTML = `<div class="empty"><div class="icon">${ico}</div>Нет данных</div>`; return; }
    
    let html = '';
    items.forEach((it, i) => {
        const cnt = it.count || it.views || 0;
        const sub = it.shows ? `${it.shows} ${plural(it.shows, ['шоу', 'шоу', 'шоу'])}` : (it.sub || '');
        const lbl = Array.isArray(unit) ? `${cnt} ${plural(cnt, unit)}` : (unit ? `${cnt} ${unit}` : cnt);
        const delay = (i + 1) * 0.05;
        
        let visual = it.emoji ? `<span style="font-size:clamp(18px,5vw,22px);line-height:1;margin-right:6px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1))">${it.emoji}</span>` : `<div class="icon" style="color:var(--text-muted)">${ico}</div>`;
        
        const safeName = it.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        const onclick = `onclick="openHistory('filter', null, null, '${safeName}', '${categoryKey}', ${i})"`;
        
        html += `<div class="li li-clickable anim-list-item clickable" ${onclick} style="animation-delay:${delay}s">
            <div class="li-l">
                <span class="li-rank">${i+1}</span>
                <div>
                    <div class="li-name">${visual} ${it.name}</div>
                    ${sub?`<div class="li-sub">${sub}</div>`:''}
                </div>
            </div>
            <span class="li-r">${lbl}</span>
        </div>`;
    });
    el.innerHTML = html;
}

function fillBinges() {
    const el = document.getElementById('binges-box');
    if (!D.binges?.length) { el.innerHTML = `<div class="empty"><div class="icon">${Icons.bolt}</div>Нет марафонов</div>`; return; }
    
    let html = '';
    D.binges.forEach((b, i) => {
        const delay = (i + 1) * 0.05;
        const safeTitle = b.show_title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        
        const posterHtml = b.poster_url 
            ? `<img src="${b.poster_url}" style="width:clamp(36px, 10vw, 44px);height:clamp(54px, 15vw, 66px);border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--bg-input);border:1px solid var(--border);box-shadow:0 2px 6px rgba(0,0,0,0.1);" onerror="this.style.display='none'">`
            : `<div style="width:clamp(36px, 10vw, 44px);height:clamp(54px, 15vw, 66px);border-radius:6px;flex-shrink:0;background:var(--bg-input);border:1px solid var(--border);"></div>`;
            
        html += `<div class="li li-clickable anim-list-item clickable" style="animation-delay:${delay}s" onclick="openHistory('binge', ${b.show_id}, '${b.date}', '${safeTitle}')">
            <div class="li-l">
                ${posterHtml}
                <div>
                    <div class="li-name">${b.show_title}</div>
                    <div class="li-sub">${b.date}</div>
                </div>
            </div>
            <span class="li-r" style="color:var(--info)">${b.count} ${plural(b.count, ['эпизод', 'эпизода', 'эпизодов'])}</span>
        </div>`;
    });
    el.innerHTML = html;
}

function renderCharts() { renderMonthly(); renderWeekday(); renderDonut(); }

const fSizeAx = Math.max(10, Math.min(13, window.innerWidth * 0.03));
const fSizeTi = Math.max(12, Math.min(15, window.innerWidth * 0.035));

function getCtxGradient(ctx, colorStart, colorEnd) {
    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorStart);
    gradient.addColorStop(1, colorEnd);
    return gradient;
}

function renderMonthly() {
    const canvas = document.getElementById('c-monthly');
    const ctx = canvas.getContext('2d');
    if (chM) chM.destroy();
    const ch = D.monthly_chart; if (!ch?.labels?.length) return;
    const c = cc();
    
    let fillGradient = getCtxGradient(ctx, isDark?'rgba(35, 134, 54, 0.4)':'rgba(46, 160, 67, 0.3)', 'rgba(35, 134, 54, 0.0)');
    let lineGradient = ctx.createLinearGradient(0, 0, canvas.width || 400, 0);
    lineGradient.addColorStop(0, '#2ea043');
    lineGradient.addColorStop(1, '#3fb950');

    chM = new Chart(ctx, { 
        type:'line', 
        data:{ 
            labels:ch.labels, 
            datasets:[
                { 
                    label: 'Просмотры',
                    data: ch.views, 
                    backgroundColor: fillGradient, 
                    borderColor: lineGradient, 
                    borderWidth: 3, 
                    tension: 0.4, 
                    fill: true,
                    yAxisID: 'y',
                    pointBackgroundColor: isDark ? '#0d1117' : '#ffffff',
                    pointBorderColor: '#3fb950',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Часы',
                    data: ch.hours, 
                    backgroundColor: 'transparent', 
                    borderColor: c.i, 
                    borderWidth: 2, 
                    borderDash: [5, 5],
                    tension: 0.4, 
                    fill: false,
                    yAxisID: 'y1',
                    pointBackgroundColor: isDark ? '#0d1117' : '#ffffff',
                    pointBorderColor: c.i,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }
            ] 
        },
        options:{ 
            responsive:true, 
            maintainAspectRatio:false, 
            animation: { duration: 1500, easing: 'easeOutQuart' },
            plugins:{ 
                legend: { 
                    display: true, 
                    position: 'top', 
                    labels: { color: c.t, usePointStyle: true, boxWidth: 8, font: { size: fSizeAx, family: 'system-ui' } } 
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(22, 27, 34, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                    titleColor: isDark ? '#f0f6fc' : '#1f2328',
                    bodyColor: isDark ? '#8b949e' : '#59636e',
                    borderColor: c.b,
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                }
            },
            interaction: { mode: 'index', intersect: false },
            scales:{ 
                x:{ ticks:{color:c.t,font:{size:fSizeAx}}, grid:{display:false} },
                y:{ 
                    type: 'linear', display: true, position: 'left',
                    ticks:{color:c.a,font:{size:fSizeAx}}, grid:{color:c.g}, beginAtZero:true 
                },
                y1: {
                    type: 'linear', display: true, position: 'right',
                    ticks:{color:c.i,font:{size:fSizeAx}}, grid:{drawOnChartArea: false}, beginAtZero:true
                }
            } 
        } 
    });
}

function renderWeekday() {
    const canvas = document.getElementById('c-weekday');
    const ctx = canvas.getContext('2d');
    if (chW) chW.destroy();
    const ch = D.weekday_chart; if (!ch?.labels?.length) return;
    const c = cc();
    
    let barGradient = getCtxGradient(ctx, '#2ea043', '#238636');
    let weGradient = getCtxGradient(ctx, '#388bfd', '#1f6feb');

    chW = new Chart(ctx, { 
        type:'bar', 
        data:{ 
            labels:ch.labels, 
            datasets:[{ 
                data:ch.data,
                backgroundColor:ch.data.map((_,i)=>i>=5?weGradient:barGradient), 
                borderRadius: 6, 
                borderSkipped:false 
            }] 
        },
        options:{ 
            responsive:true, 
            maintainAspectRatio:false, 
            animation: { duration: 1200, easing: 'easeOutQuart' },
            plugins:{ 
                legend:{display:false},
                tooltip: {
                    backgroundColor: isDark ? 'rgba(22, 27, 34, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                    titleColor: isDark ? '#f0f6fc' : '#1f2328',
                    bodyColor: isDark ? '#8b949e' : '#59636e',
                    borderColor: c.b,
                    borderWidth: 1,
                    cornerRadius: 8,
                }
            },
            scales:{ 
                x:{ ticks:{color:c.t,font:{size:fSizeAx}}, grid:{display:false} },
                y:{ ticks:{color:c.t,font:{size:fSizeAx}}, grid:{color:c.g}, beginAtZero:true, border:{display:false} } 
            } 
        } 
    });
}

function renderDonut() {
    const ctx = document.getElementById('c-genre');
    if (chG) chG.destroy();
    if (!D.genres?.length) return;
    
    const c = cc();
    const pal = ['#2ea043','#388bfd','#d29922','#a371f7','#f85149','#1abc9c','#e67e22','#ecf0f1'];
    const top = D.genres.slice(0,6);
    const totalMins = Math.max(top.reduce((acc, g) => acc + g.minutes, 0), 1);
    
    const labelsWithTime = top.map(g => {
        const h = Math.floor(g.minutes / 60);
        const m = g.minutes % 60;
        return `${g.name} (${h}ч ${m}м)`;
    });

    chG = new Chart(ctx, { 
        type:'doughnut', 
        plugins: [ChartDataLabels],
        data:{ 
            labels: labelsWithTime, 
            datasets:[{ 
                data: top.map(g => g.minutes), 
                backgroundColor: top.map((_,i)=>pal[i%pal.length]), 
                borderWidth: 2,
                borderColor: isDark ? '#161b22' : '#ffffff',
                hoverOffset: 25,
                hoverBorderWidth: 4,
                spacing: 4,
                borderRadius: 4
            }] 
        },
        options:{ 
            responsive:true, 
            maintainAspectRatio:false, 
            cutout:'65%', 
            layout: { padding: 30 },
            animation: { 
                animateScale: true, 
                animateRotate: true, 
                duration: 2000, 
                easing: 'easeOutElastic' 
            },
            onClick: (event, elements) => {
                if (elements && elements.length > 0) {
                    const idx = elements[0].index;
                    const genre = top[idx];
                    openHistory('filter', null, null, genre.name, 'genres', idx);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements && elements.length ? 'pointer' : 'default';
            },
            plugins:{ 
                datalabels: {
                    color: '#ffffff',
                    font: { weight: '800', size: 11, family: 'system-ui' },
                    textShadowBlur: 4,
                    textShadowColor: 'rgba(0,0,0,0.5)',
                    formatter: (value) => {
                        let pct = Math.round((value / totalMins) * 100);
                        return pct > 5 ? pct + '%' : '';
                    }
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(22, 27, 34, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                    titleColor: isDark ? '#f0f6fc' : '#1f2328',
                    bodyColor: isDark ? '#8b949e' : '#59636e',
                    borderColor: c.b,
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 10,
                    callbacks: {
                        label: (context) => ` ${Math.round((context.parsed / totalMins) * 100)}%`
                    }
                },
                legend:{ 
                    position:'right', 
                    labels:{ color:c.t, font:{size:11, weight: '600'}, padding:10, usePointStyle:true, pointStyleWidth:8 }
                } 
            } 
        } 
    });
}

window.mainTab = function(t) {
    document.querySelectorAll('#main-tabs .tab').forEach(b=>b.classList.toggle('on', b.dataset.tab===t));
    document.getElementById('sec-personal').classList.toggle('vis', t==='personal');
    document.getElementById('sec-group').classList.toggle('vis', t==='group');
};

window.openHistory = function(type, extraId, extraDate, extraTitle, extraKey, extraIndex) {
    document.getElementById('main-tabs').classList.add('hidden');
    document.getElementById('years').classList.add('hidden');
    document.getElementById('sec-personal').classList.remove('vis');
    document.getElementById('sec-group').classList.remove('vis');
    
    const secHist = document.getElementById('sec-history');
    secHist.classList.add('vis');
    
    if (tg && tg.BackButton) {
        tg.BackButton.show();
        tg.BackButton.onClick(window.closeHistory);
    }
    
    const el = document.getElementById('hist-list');
    el.innerHTML = '';
    
    let data;
    if (type === 'all') {
        data = [...D.history_movies, ...D.history_episodes].sort((a, b) => {
            if (b.view_date !== a.view_date) return b.view_date.localeCompare(a.view_date);
            return (b.show_id + (b.episode_number || 0)) - (a.show_id + (a.episode_number || 0));
        });
        document.getElementById('hist-title').textContent = 'Вся история просмотров';
        document.getElementById('ic-hist-type').innerHTML = Icons.dash;
    } else if (type === 'binge') {
        data = D.history_episodes.filter(i => i.show_id === extraId && i.view_date === extraDate)
            .sort((a, b) => {
                if (a.season_number !== b.season_number) return a.season_number - b.season_number;
                return a.episode_number - b.episode_number;
            });
        document.getElementById('hist-title').textContent = extraTitle;
        document.getElementById('ic-hist-type').innerHTML = Icons.bolt;
    } else if (type === 'filter') {
        const filterItem = D[extraKey][extraIndex];
        const allowedIds = filterItem.show_ids || [];
        
        data = [...D.history_movies, ...D.history_episodes].filter(i => allowedIds.includes(i.show_id))
            .sort((a, b) => b.view_date.localeCompare(a.view_date));
            
        document.getElementById('hist-title').textContent = extraTitle;
        
        let iconHtml = Icons.star;
        if (extraKey === 'genres') iconHtml = Icons.masks;
        else if (extraKey === 'countries') iconHtml = Icons.globe;
        document.getElementById('ic-hist-type').innerHTML = iconHtml;
        
    } else {
        data = type === 'movies' ? D.history_movies : D.history_episodes;
        document.getElementById('hist-title').textContent = type === 'movies' ? 'Просмотренные фильмы' : 'Просмотренные эпизоды';
        document.getElementById('ic-hist-type').innerHTML = type === 'movies' ? Icons.film : Icons.tv;
    }
    
    if (!data || !data.length) {
        let emptyIco = Icons.dash;
        if (type === 'movies') emptyIco = Icons.film;
        else if (type === 'binge') emptyIco = Icons.bolt;
        else if (type === 'filter') emptyIco = document.getElementById('ic-hist-type').innerHTML;
        else emptyIco = Icons.tv;
        
        el.innerHTML = `<div class="empty"><div class="icon">${emptyIco}</div>Нет просмотров</div>`;
        return;
    }
    
    let html = '<div class="card" style="margin:0; padding:0; overflow:hidden;">';
    data.forEach((item, idx) => {
        const delay = Math.min((idx + 1) * 0.03, 0.6); 
        
        let metaHtml = '';
        if (item.season_number !== undefined && item.season_number > 0) {
            const s = item.season_number;
            const e = item.episode_number < 10 ? '0'+item.episode_number : item.episode_number;
            metaHtml += `<span class="hist-badge">s${s}e${e}</span>`;
            
            if (item.user_rating) {
                const rVal = Number.isInteger(item.user_rating) ? item.user_rating : item.user_rating.toFixed(1);
                metaHtml += `<span class="rating-badge">${Icons.star}${rVal}</span>`;
            }
            
            if (item.user_show_rating) {
                const rsVal = Number.isInteger(item.user_show_rating) ? item.user_show_rating : item.user_show_rating.toFixed(1);
                metaHtml += `<span class="rating-badge show-lvl">(${rsVal})</span>`;
            }
        } else {
            if (item.user_rating) {
                const rVal = Number.isInteger(item.user_rating) ? item.user_rating : item.user_rating.toFixed(1);
                metaHtml += `<span class="rating-badge">${Icons.star}${rVal}</span>`;
            }
        }

        const origTitle = item.show__original_title && item.show__original_title !== item.show__title 
            ? `<div class="hist-orig">${item.show__original_title}</div>` 
            : '';
            
        const yearSuffix = item.show__year ? ` <span style="color:var(--text-muted); font-weight:500;">(${item.show__year})</span>` : '';
        const poster = item.poster_url 
            ? `<img src="${item.poster_url}" class="hist-poster" alt="poster" loading="lazy" onerror="this.style.display='none'">` 
            : `<div class="hist-poster"></div>`;

        html += `
        <div class="hist-item anim-item clickable" style="animation-delay:${delay}s;">
            ${poster}
            <div class="hist-info">
                <div class="hist-title">${item.show__title}${yearSuffix}</div>
                ${origTitle}
                <div class="hist-meta">${metaHtml}<span>${item.view_date}</span></div>
            </div>
        </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
    window.scrollTo(0, 0);
};

window.closeHistory = function() {
    if (tg && tg.BackButton) {
        tg.BackButton.hide();
        tg.BackButton.offClick(window.closeHistory);
    }
    document.getElementById('main-tabs').classList.remove('hidden');
    document.getElementById('years').classList.remove('hidden');
    document.getElementById('sec-history').classList.remove('vis');
    
    const curTab = document.querySelector('#main-tabs .tab.on').dataset.tab;
    mainTab(curTab);
};

function renderGroup() {
    const el = document.getElementById('group-root');
    if (!D.group) { el.innerHTML = `<div class="card hoverable"><div class="empty"><div class="icon" style="font-size:clamp(36px, 10vw, 48px);line-height:1;color:var(--text-muted)">${Icons.users}</div>Вы не состоите в группе</div></div>`; return; }
    const g = D.group, p = D.summary;

    const rows = [
        { lb:'Просмотры', i:Icons.tv, y:p.total_views, gv:g.total_views },
        { lb:'Эпизоды', i:Icons.film, y:p.total_episodes, gv:g.total_episodes },
        { lb:'Фильмы', i:Icons.time, y:p.total_movies, gv:g.total_movies },
        { lb:'Уникальных', i:Icons.star, y:p.unique_shows, gv:g.unique_shows },
    ];
    let hasDiff = false;
    const cmpH = rows.map((r, idx) => {
        const d = r.y - r.gv;
        let dh;
        if (d===0) dh = `<span class="cmp-d d-eq"><div class="icon" style="font-size:clamp(12px, 3.2vw, 14px);display:inline-block;vertical-align:middle;line-height:1">${Icons.check}</div> Мэтч</span>`;
        else { hasDiff = true; dh = `<span class="cmp-d ${d>0?'d-up':'d-dn'}">${d>0?'+':''}${d}</span>`; }
        return `<div class="cmp anim-item" style="animation-delay:${(idx+1)*0.05}s"><span class="cmp-lb"><div class="icon" style="font-size:clamp(16px, 4.5vw, 20px);line-height:1;color:var(--text-muted)">${r.i}</div>${r.lb}</span><div class="cmp-vs"><span class="cmp-v cmp-you">${r.y}</span><span style="color:var(--text-muted);font-size:clamp(11px, 3vw, 13px)">vs</span><span class="cmp-v cmp-grp">${r.gv}</span>${dh}</div></div>`;
    }).join('');

    const mx = Math.max(...g.members.map(m=>m.views),1);
    const mbH = g.members.map((m, idx) => `<div class="mb anim-list-item" style="animation-delay:${(idx+1)*0.05}s"><span class="mb-n">${m.name}</span><div class="mb-t"><div class="mb-f" style="width:${(m.views/mx)*100}%"></div></div><span class="mb-c">${m.views}</span></div>`).join('');

    let gGenH = '';
    if (g.genres?.length) {
        const gm = Math.max(...g.genres.map(x=>x.minutes),1);
        gGenH = `<div class="label"><div class="icon" style="font-size:clamp(16px, 4.5vw, 18px);line-height:1">${Icons.masks}</div>Жанры группы</div><div class="card hoverable anim-item" style="animation-delay:0.3s">` + g.genres.slice(0,5).map((x, idx) => {
            const w=(x.minutes/gm)*100, h=Math.floor(x.minutes/60), m=x.minutes%60;
            return `<div class="g-row anim-list-item" style="animation-delay:${(idx+1)*0.05}s"><div class="g-hdr"><span class="g-name">${x.name}</span><span class="g-time">${h}ч ${m}м</span></div><div class="g-track"><div class="g-fill" style="width:${w}%;background:linear-gradient(90deg, var(--info), #a371f7)"></div></div></div>`;
        }).join('') + '</div>';
    }

    const membersLabel = `${g.members_count} ${plural(g.members_count, ['участник', 'участника', 'участников'])}`;

    el.innerHTML = `
        <div class="card hoverable anim-item"><div style="display:flex;align-items:center;gap:16px"><div class="icon" style="font-size:clamp(28px, 8vw, 36px);line-height:1;color:var(--info);filter:drop-shadow(0 4px 8px rgba(56, 139, 253, 0.3))">${Icons.users}</div><div><div style="font-size:clamp(16px, 4.5vw, 20px);font-weight:800;color:var(--text-primary)">${g.group_name}</div><div style="font-size:clamp(12px, 3.2vw, 14px);color:var(--text-muted);font-weight:600;margin-top:2px;">${membersLabel} · ${g.duration_display}</div></div></div></div>
        <div class="label"><div class="icon" style="font-size:clamp(16px, 4.5vw, 18px);line-height:1">${Icons.chart}</div>Вы vs Группа</div>
        <div class="card hoverable anim-item" style="animation-delay:0.1s">
            <div style="display:flex;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)"><span style="font-size:clamp(12px, 3.2vw, 14px);font-weight:800;color:var(--accent);letter-spacing:0.5px;text-transform:uppercase;">👤 Вы</span><span style="font-size:clamp(12px, 3.2vw, 14px);font-weight:800;color:var(--info);letter-spacing:0.5px;text-transform:uppercase;">👥 Группа</span></div>
            ${!hasDiff?`<div style="text-align:center;padding:16px 0;font-size:clamp(15px, 4vw, 18px);color:var(--accent);font-weight:800;display:flex;align-items:center;justify-content:center;gap:8px;animation:pulse 2s infinite;"><div class="icon" style="font-size:clamp(20px, 6vw, 24px);line-height:1">${Icons.check}</div> Полный мэтч!</div>`:''}
            ${cmpH}
        </div>
        <div class="label"><div class="icon" style="font-size:clamp(16px, 4.5vw, 18px);line-height:1">${Icons.user}</div>Участники</div>
        <div class="card hoverable anim-item" style="animation-delay:0.2s">${mbH}</div>
        ${gGenH}`;
}

load();
</script>
</body>
</html>