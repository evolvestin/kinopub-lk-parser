{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KinoStats App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="{% static 'css/webapp.css' %}">
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>
    <div id="shared-banner-container"></div>
    
    <div id="app" class="hidden">
        <div class="header">
            <div class="header-left">
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="header-name glow-text" id="user-name">Загрузка…</div>
                    <div class="header-sub" id="period-label"></div>
                </div>
            </div>
            <div class="top-controls">
                <button class="share-btn" id="share-btn" onclick="window.App.openShareModal()">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
                <button class="theme-btn" id="theme-btn" onclick="window.App.toggleTheme()"></button>
            </div>
        </div>

        <div id="views-container">
            <!-- VIEW: STATS -->
            <div class="view active-view" id="view-stats">
                <div class="tabs" id="main-tabs">
                    <button class="tab on" data-tab="personal" onclick="window.App.mainTab('personal')">
                        <div class="icon" id="ic-user"></div>Личная
                    </button>
                    <button class="tab" data-tab="group" id="tab-group-btn" onclick="window.App.mainTab('group')">
                        <div class="icon" id="ic-users"></div>Группа
                    </button>
                </div>

                <div class="years" id="years"></div>

                <div id="sec-personal">
                    <div class="label" id="label-overview"><div class="icon" id="ic-dash"></div>Обзор</div>
                    <div class="grid" id="grid-overview">
                        <div class="stat anim-item clickable" style="animation-delay: 0.05s" onclick="window.App.openHistory('all')">
                            <div class="stat-icon" id="ic-time"></div>
                            <div class="stat-val" id="s-time">—</div>
                            <div class="stat-lbl">Время просмотра</div>
                            <div class="stat-sub" id="s-views"></div>
                        </div>
                        <div class="stat anim-item" style="animation-delay: 0.1s">
                            <div class="stat-icon" id="ic-cal"></div>
                            <div class="stat-val" id="s-act">0%</div>
                            <div class="stat-lbl">Активность</div>
                            <div class="stat-sub" id="s-daily" style="background: var(--info-dim); color: var(--info)"></div>
                        </div>
                        <div class="stat anim-item clickable" style="animation-delay: 0.15s" onclick="window.App.openHistory('episodes')">
                            <div class="stat-icon" id="ic-tv"></div>
                            <div class="stat-val" id="s-ep">0</div>
                            <div class="stat-lbl">Эпизодов</div>
                            <div class="stat-sub" id="s-ser" style="background: rgba(163, 113, 247, 0.15); color: #a371f7"></div>
                        </div>
                        <div class="stat anim-item clickable" style="animation-delay: 0.2s" onclick="window.App.openHistory('movies')">
                            <div class="stat-icon" id="ic-film"></div>
                            <div class="stat-val" id="s-mov">0</div>
                            <div class="stat-lbl">Фильмов</div>
                            <div class="stat-sub" id="s-uni" style="background: rgba(210, 153, 34, 0.15); color: #d29922"></div>
                        </div>
                    </div>

                    <div class="card hoverable anim-item" id="card-dynamics" style="animation-delay: 0.25s">
                        <div class="label"><div class="icon" style="color:var(--info)" id="ic-chart-internal"></div>Динамика</div>
                        <div class="chart-box"><canvas id="c-monthly"></canvas></div>
                    </div>

                    <div class="card hoverable anim-item" id="card-weekday" style="animation-delay: 0.3s">
                        <div class="label more-pad"><div class="icon" style="color:#2ecc71" id="ic-weekday-internal"></div>Дни недели</div>
                        <div class="chart-box" style="height:180px"><canvas id="c-weekday"></canvas></div>
                    </div>

                    <div class="card hoverable anim-item" id="card-heatmap" style="animation-delay: 0.35s">
                        <div class="label more-pad"><div class="icon" style="color:#f85149" id="ic-flame-internal"></div>Интенсивность</div>
                        <div id="heatmaps-wrapper"></div>
                        <div class="hm-leg">
                            <span>Меньше</span>
                            <div class="hc"></div><div class="hc h1"></div><div class="hc h2"></div><div class="hc h3"></div><div class="hc h4"></div>
                            <span>Больше</span>
                        </div>
                    </div>

                    <div class="card hoverable anim-item" id="card-genres" style="animation-delay: 0.1s; margin-bottom: clamp(12px, 3vw, 16px);">
                        <div class="label"><div class="icon" id="it-gen-internal"></div>Жанры</div>
                        <div class="chart-box" style="height:380px;"><canvas id="c-genre"></canvas></div>
                        <div id="legend-genre" class="legend-grid"></div>
                    </div>

                    <div class="card hoverable anim-item" style="animation-delay: 0.15s;" id="card-actors">
                        <div class="label"><div class="icon" style="color: #d29922;" id="it-act-internal"></div>Актёры</div>
                        <div id="actors-list"></div>
                    </div>

                    <div class="card hoverable anim-item" style="animation-delay: 0.2s;" id="card-countries">
                        <div class="label"><div class="icon" style="color: #388bfd;" id="it-cou-internal"></div>Страны</div>
                        <div id="countries-list"></div>
                    </div>

                    <div class="card hoverable anim-item" style="animation-delay: 0.25s;" id="card-binges">
                        <div class="label"><div class="icon" style="color: #a371f7;" id="it-bin-internal"></div>Марафоны</div>
                        <div id="binges-list"></div>
                    </div>

                    <div class="card hoverable anim-item" style="animation-delay: 0.3s;" id="ratings-box">
                        <div class="label"><div class="icon" style="color: #f1c40f;" id="it-star-internal"></div>Оценки</div>
                        <div class="critic-header">
                            <div class="critic-title-box">
                                <div class="critic-badge" id="cr-badge"></div>
                                <div class="critic-avg" id="cr-avg">0.0<span>/ 10</span></div>
                            </div>
                            <div class="critic-total" id="cr-total"></div>
                        </div>
                        <div class="chart-box" style="height: 180px; margin-bottom: 16px;"><canvas id="c-ratings-dist"></canvas></div>
                        <div class="stat clickable" style="flex-direction: row; justify-content: center; align-items: center; padding: 16px; margin-top: 12px; border-radius: 15px;" onclick="window.App.openHistory('ratings')">
                            <span style="font-weight: 800; color: var(--text-primary); font-size: clamp(14px, 4vw, 16px);">Все оценки</span>
                        </div>
                    </div>
                </div>

                <div id="sec-group" class="hidden"><div id="group-root"></div></div>
            </div>

            <!-- VIEW: HISTORY -->
            <div class="view hidden" id="view-history">
                <div class="header" style="padding-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="window.App.closeHistory()" class="tab clickable" style="background:var(--bg-input); color:var(--text-primary); margin-bottom:clamp(12px, 3.5vw, 16px); display:inline-flex;">
                        <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right:6px;"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> Назад
                    </button>
                    <div class="view-toggle" id="view-toggle">
                        <button class="vt-btn" id="vt-grid" onclick="window.App.setViewMode('grid')"></button>
                        <button class="vt-btn" id="vt-list" onclick="window.App.setViewMode('list')"></button>
                    </div>
                </div>
                <div class="label" style="padding-top:0;"><span id="hist-title"></span></div>
                <div id="hist-list-container" style="padding: 0 clamp(12px, 3vw, 16px) 0;"></div>
                <div id="history-sentinel"></div>
            </div>
            
            <!-- VIEW: CATALOG (Future Aggregator Feature) -->
            <div class="view" id="view-catalog">
                <!-- Задел на будущее (Каталог, Поиск, и т.д.) -->
            </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Поделиться статистикой</div>
                <button class="modal-close" onclick="window.App.closeShareModal()">×</button>
            </div>
            
            <div class="share-section-title">Годы для экспорта</div>
            <div class="years-grid" id="share-years-grid"></div>

            <div class="share-section-title">Конфиденциальность</div>
            <div class="share-opts">
                <label class="chk-row">
                    <input type="checkbox" id="sh-anon-user">
                    <div class="chk-box"></div>
                    <span class="chk-text">Скрыть мой профиль (Аноним)</span>
                </label>
                <label class="chk-row" id="sh-group-wrap">
                    <input type="checkbox" id="sh-inc-group" checked onchange="window.App.toggleGroupOpts()">
                    <div class="chk-box"></div>
                    <span class="chk-text">Включить вкладку "Группа"</span>
                </label>
                <label class="chk-row" id="sh-anon-group-wrap" style="padding-left:34px;">
                    <input type="checkbox" id="sh-anon-group">
                    <div class="chk-box"></div>
                    <span class="chk-text">Скрыть имена участников группы</span>
                </label>
            </div>

            <button class="btn-primary" id="btn-do-share" onclick="window.App.submitShare()">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Создать ссылку
            </button>
        </div>
    </div>

    <script src="{% static 'js/webapp.js' %}?v=1.2"></script>
    <script>
        // Запуск логики приложения с защитой от незагруженного файла
        if (typeof init === 'function') {
            init();
        } else {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').innerHTML = '<div style="padding: 40px; text-align: center; color: #e74c3c; font-family: sans-serif; font-size: 16px;"><b>Критическая ошибка:</b><br><br>Скрипт приложения не загрузился. Пожалуйста, очистите кэш Telegram или перезапустите WebApp.</div>';
            document.getElementById('app').classList.remove('hidden');
        }
    </script>
</body>
</html>