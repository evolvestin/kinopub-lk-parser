<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KinoStats</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-main: #14181f;
            --bg-card: #1b1f26;
            --bg-input: #232830;
            --border: #2d333b;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #2ecc71;
            --accent-dim: rgba(46, 204, 113, 0.15);
            --info: #60a5fa;
            --danger: #e74c3c;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .light {
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #e5e7eb;
            --border: #d1d5db;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-main);
            color: var(--text-secondary);
            font-family: var(--tg-theme-font-family, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif);
            font-size: clamp(14px, 4vw, 16px);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: clamp(20px, 6vw, 28px);
            transition: background .3s ease, color .3s ease;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: clamp(12px, 3.5vw, 16px);
            margin: 0 clamp(12px, 3.5vw, 16px) clamp(10px, 3vw, 12px);
            box-shadow: var(--shadow);
            transition: background .3s ease, border-color .3s ease;
        }

        .clickable { cursor: pointer; transition: transform .2s ease, background .3s ease; }
        .clickable:active { transform: scale(.96); background: var(--bg-input); }

        .header { display: flex; align-items: center; justify-content: space-between; padding: clamp(12px, 4vw, 16px) clamp(12px, 4vw, 16px) clamp(4px, 1.5vw, 6px); }
        .header-left { display: flex; align-items: center; gap: clamp(8px, 2.5vw, 12px); }
        .avatar {
            width: clamp(40px, 11vw, 48px); height: clamp(40px, 11vw, 48px); border-radius: 50%;
            background: var(--bg-input); display: flex; align-items: center; justify-content: center;
            font-size: clamp(18px, 5vw, 22px); font-weight: 700; color: var(--text-primary); flex-shrink: 0;
            overflow: hidden; border: 1px solid var(--border);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .header-name { font-size: clamp(16px, 5vw, 20px); font-weight: 700; color: var(--text-primary); }
        .header-sub  { font-size: clamp(11px, 3vw, 14px); color: var(--text-muted); margin-top: 1px; }
        .theme-btn {
            width: clamp(32px, 9vw, 40px); height: clamp(32px, 9vw, 40px); border-radius: 50%;
            background: var(--bg-input); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-primary); transition: transform .2s ease;
        }
        .theme-btn:active { transform: scale(.9); }
        .theme-btn .icon { font-size: clamp(18px, 5vw, 22px); line-height: 1; }

        .tabs { display: flex; gap: clamp(6px, 2vw, 8px); padding: clamp(6px, 2vw, 8px) clamp(12px, 4vw, 16px) clamp(4px, 1vw, 4px); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            display: flex; align-items: center; gap: clamp(4px, 1.5vw, 6px); flex-shrink: 0; padding: clamp(6px, 2vw, 8px) clamp(12px, 3.5vw, 16px); border-radius: 10px;
            font-size: clamp(13px, 3.5vw, 15px); font-weight: 600; white-space: nowrap;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-muted); cursor: pointer; transition: all .2s ease;
        }
        .tab .icon { font-size: clamp(15px, 4vw, 18px); line-height: 1; }
        .tab.on { background: var(--accent); color: #fff; border-color: var(--accent); }
        .tab:not(.on):active { transform: scale(.96); }

        .years { display: flex; gap: clamp(4px, 1.5vw, 6px); padding: clamp(4px, 1vw, 4px) clamp(12px, 4vw, 16px) clamp(6px, 2vw, 8px); overflow-x: auto; }
        .years::-webkit-scrollbar { display: none; }
        .yr {
            flex-shrink: 0; padding: clamp(4px, 1.5vw, 6px) clamp(10px, 3vw, 14px); border-radius: 8px;
            font-size: clamp(12px, 3.2vw, 14px); font-weight: 600;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-muted); cursor: pointer; transition: all .2s ease;
        }
        .yr.on { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        .label {
            display: flex; align-items: center; gap: clamp(4px, 1.5vw, 6px);
            font-size: clamp(11px, 3vw, 13px); font-weight: 700; text-transform: uppercase;
            letter-spacing: .5px; color: var(--text-muted); padding: clamp(10px, 3vw, 12px) clamp(12px, 4vw, 16px) clamp(4px, 1.5vw, 6px);
        }
        .label .icon { font-size: clamp(13px, 3.5vw, 16px); line-height: 1; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(8px, 2.5vw, 12px); padding: 0 clamp(12px, 4vw, 16px) clamp(10px, 3vw, 12px); }
        .stat {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: clamp(10px, 3vw, 14px); box-shadow: var(--shadow);
            transition: background .3s ease; display: flex; flex-direction: column;
        }
        .stat-icon  { font-size: clamp(22px, 6vw, 26px); line-height: 1; margin-bottom: clamp(6px, 2vw, 8px); }
        .stat-val   { font-size: clamp(20px, 5.5vw, 24px); font-weight: 800; color: var(--text-primary); line-height: 1.1; }
        .stat-lbl   { font-size: clamp(10px, 2.8vw, 12px); color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: .3px; margin-top: clamp(2px, 1vw, 4px); }
        .stat-sub   { font-size: clamp(11px, 3vw, 13px); color: var(--accent); margin-top: clamp(2px, 1vw, 4px); font-weight: 500; }
        .stat.clickable {
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.2s ease;
        }
        .stat.clickable:active {
            transform: scale(0.97);
            background-color: var(--bg-input);
        }
        
        .stat.clickable::after {
            content: '';
            position: absolute;
            top: 50%;
            right: clamp(12px, 3.5vw, 16px);
            transform: translateY(-50%) rotate(45deg);
            width: clamp(7px, 2vw, 10px);
            height: clamp(7px, 2vw, 10px);
            border-top: 2px solid var(--accent);
            border-right: 2px solid var(--accent);
            opacity: 0.9;
        }

        .g-row { margin-bottom: clamp(10px, 3vw, 12px); }
        .g-hdr { display: flex; justify-content: space-between; font-size: clamp(12px, 3.2vw, 14px); font-weight: 600; margin-bottom: clamp(4px, 1.5vw, 6px); }
        .g-name { color: var(--text-primary); }
        .g-time { color: var(--text-muted); }
        .g-track { height: clamp(5px, 1.5vw, 7px); background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .g-fill  { height: 100%; border-radius: 3px; background: var(--accent); transition: width .6s cubic-bezier(0.16, 1, 0.3, 1); }

        .li { display: flex; align-items: center; justify-content: space-between; padding: clamp(10px, 3vw, 12px) 0; border-bottom: 1px solid var(--border); }
        .li:last-child { border: none; }
        .li-l { display: flex; align-items: center; gap: clamp(8px, 2.5vw, 12px); min-width: 0; flex: 1; }
        .li-r { font-size: clamp(13px, 3.5vw, 15px); font-weight: 700; color: var(--text-primary); flex-shrink: 0; margin-left: 8px; text-align: right; }
        .li-rank { font-size: clamp(12px, 3.2vw, 14px); font-weight: 700; color: var(--text-muted); width: clamp(20px, 5vw, 24px); text-align: center; flex-shrink: 0; }
        .li-name { display: flex; align-items: center; gap: clamp(4px, 1.5vw, 6px); font-size: clamp(13px, 3.5vw, 15px); font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .li-name .icon { font-size: clamp(14px, 4vw, 16px); line-height: 1; }
        .li-sub  { font-size: clamp(11px, 3vw, 13px); color: var(--text-muted); margin-top: 2px; }

        .hm { 
            display: grid; 
            grid-template-rows: repeat(7, 1fr); 
            grid-auto-flow: column; 
            gap: clamp(1px, 0.5vw, 2px); 
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .hc { 
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 20%; 
            background: var(--bg-input); 
            transition: transform 0.2s ease;
        }
        
        .hc:active { transform: scale(1.3); z-index: 10; }
        .h1 { background: rgba(46, 204, 113, 0.3); } 
        .h2 { background: rgba(46, 204, 113, 0.5); } 
        .h3 { background: rgba(46, 204, 113, 0.8); } 
        .h4 { background: var(--accent); }
        
        .hm-leg { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            justify-content: flex-end; 
            margin-top: clamp(6px, 2vw, 8px); 
            font-size: clamp(9px, 2.5vw, 11px); 
            color: var(--text-muted); 
            text-transform: uppercase;
            font-weight: 700;
        }
        .hm-leg .hc { width: clamp(8px, 2.5vw, 12px); height: clamp(8px, 2.5vw, 12px); border-radius: 2px; }

        .hm-container {
            width: 100%;
            overflow: hidden; 
        }

        .chart-box { position: relative; width: 100%; height: 200px; }

        .cmp { display: flex; justify-content: space-between; align-items: center; padding: clamp(8px, 2.5vw, 10px) 0; border-bottom: 1px solid var(--border); }
        .cmp:last-child { border: none; }
        .cmp-lb { font-size: clamp(12px, 3.2vw, 14px); color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: clamp(4px, 1.5vw, 6px); }
        .cmp-lb .icon { font-size: clamp(14px, 3.8vw, 16px); line-height: 1; }
        .cmp-vs { display: flex; gap: clamp(8px, 2.5vw, 12px); align-items: center; }
        .cmp-v  { font-size: clamp(13px, 3.5vw, 15px); font-weight: 700; text-align: right; min-width: clamp(36px, 10vw, 44px); }
        .cmp-you { color: var(--accent); }
        .cmp-grp { color: var(--info); }
        .cmp-d  { font-size: clamp(10px, 2.8vw, 12px); font-weight: 600; padding: clamp(2px, 0.8vw, 3px) clamp(4px, 1.5vw, 6px); border-radius: 4px; }
        .d-up   { background: var(--accent-dim); color: var(--accent); }
        .d-dn   { background: rgba(231, 76, 60, 0.15); color: var(--danger); }
        .d-eq   { background: var(--bg-input); color: var(--text-muted); }

        .mb { display: flex; align-items: center; gap: clamp(8px, 2.5vw, 10px); margin-bottom: clamp(8px, 2.5vw, 10px); }
        .mb-n { font-size: clamp(12px, 3.2vw, 14px); font-weight: 600; color: var(--text-primary); width: clamp(60px, 18vw, 80px); text-align: right; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mb-t { flex: 1; height: clamp(6px, 2vw, 8px); background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .mb-f { height: 100%; border-radius: 4px; background: var(--info); transition: width .6s cubic-bezier(0.16, 1, 0.3, 1); }
        .mb-c { font-size: clamp(11px, 3vw, 13px); font-weight: 700; color: var(--text-muted); width: clamp(28px, 8vw, 36px); flex-shrink: 0; }

        .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: clamp(24px, 7vw, 32px) clamp(12px, 3.5vw, 16px); color: var(--text-muted); font-size: clamp(13px, 3.5vw, 15px); text-align: center; }
        .empty .icon { font-size: clamp(28px, 8vw, 36px); line-height: 1; margin-bottom: clamp(8px, 2.5vw, 12px); opacity: 0.5; display: inline-flex; align-items: center; justify-content: center; }

        .loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: var(--bg-main); transition: opacity .3s; }
        .spinner { width: clamp(24px, 7vw, 32px); height: clamp(24px, 7vw, 32px); border: 3px solid var(--bg-input); border-top-color: var(--accent); border-radius: 50%; animation: spin .8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .sec { display: none; }
        .sec.vis { display: block; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        @keyframes springUp {
            0% { opacity: 0; transform: translateY(16px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .anim-item { animation: springUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) both; }
        .d1 { animation-delay: 0.05s; }
        .d2 { animation-delay: 0.1s; }
        .d3 { animation-delay: 0.15s; }
        .d4 { animation-delay: 0.2s; }
        .d5 { animation-delay: 0.25s; }

        svg { width: 1em; height: 1em; vertical-align: -0.125em; display: inline-block; flex-shrink: 0; fill: currentColor; }
        .hist-item { display: flex; gap: clamp(10px, 3vw, 14px); padding: clamp(10px, 3vw, 14px) clamp(12px, 3.5vw, 16px); border-bottom: 1px solid var(--border); }
        .hist-item:last-child { border: none; }
        .hist-poster { width: clamp(40px, 12vw, 48px); height: clamp(60px, 18vw, 72px); border-radius: 6px; object-fit: cover; background: var(--bg-input); flex-shrink: 0; border: 1px solid var(--border); }
        .hist-info { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .hist-title { font-size: clamp(14px, 4vw, 16px); font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; margin-bottom: 2px; }
        .hist-orig { font-size: clamp(11px, 3vw, 13px); color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .hist-meta { font-size: clamp(11px, 3vw, 13px); color: var(--text-secondary); display: flex; gap: clamp(6px, 2vw, 8px); align-items: center; flex-wrap: wrap; }
        .hist-badge { background: var(--bg-input); padding: clamp(2px, 0.5vw, 3px) clamp(4px, 1.5vw, 6px); border-radius: 4px; font-size: clamp(10px, 2.8vw, 12px); font-weight: 700; color: var(--text-primary); border: 1px solid var(--border); }
        .rating-badge { display: inline-flex; align-items: center; gap: 3px; color: var(--accent); font-weight: 700; font-size: clamp(11px, 3vw, 13px); }
        .rating-badge.show-lvl { color: var(--text-muted); font-weight: 500; }
        .rating-badge svg { font-size: clamp(12px, 3.2vw, 14px); }
    </style>
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>

    <div id="app" class="hidden">
        <div class="header">
            <div class="header-left">
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="header-name" id="user-name">Загрузка…</div>
                    <div class="header-sub" id="period-label"></div>
                </div>
            </div>
            <button class="theme-btn" id="theme-btn" onclick="toggleTheme()"></button>
        </div>

        <div class="tabs" id="main-tabs">
            <button class="tab on" data-tab="personal" onclick="mainTab('personal')">
                <div class="icon" id="ic-user"></div>Личная
            </button>
            <button class="tab" data-tab="group" onclick="mainTab('group')">
                <div class="icon" id="ic-users"></div>Группа
            </button>
        </div>

        <div class="years" id="years"></div>

        <div class="sec vis" id="sec-personal">
            <div class="label"><div class="icon" id="ic-dash"></div>Обзор</div>
            <div class="grid">
                <div class="stat anim-item d1 clickable" onclick="openHistory('all')">
                    <div class="stat-icon" id="ic-time"></div>
                    <div class="stat-val" id="s-time">—</div>
                    <div class="stat-lbl">Время просмотра</div>
                    <div class="stat-sub" id="s-views"></div>
                </div>
                <div class="stat anim-item d2">
                    <div class="stat-icon" id="ic-cal"></div>
                    <div class="stat-val" id="s-act">0%</div>
                    <div class="stat-lbl">Активность</div>
                    <div class="stat-sub" id="s-daily"></div>
                </div>
                <div class="stat anim-item d3 clickable" onclick="openHistory('episodes')">
                    <div class="stat-icon" id="ic-tv"></div>
                    <div class="stat-val" id="s-ep">0</div>
                    <div class="stat-lbl">Эпизодов</div>
                    <div class="stat-sub" id="s-ser"></div>
                </div>
                <div class="stat anim-item d4 clickable" onclick="openHistory('movies')">
                    <div class="stat-icon" id="ic-film"></div>
                    <div class="stat-val" id="s-mov">0</div>
                    <div class="stat-lbl">Фильмов</div>
                    <div class="stat-sub" id="s-uni"></div>
                </div>
            </div>

            <div class="card anim-item d2">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:clamp(12px, 3.5vw, 16px)">
                    <span style="font-size:clamp(13px, 3.5vw, 15px);font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:6px">
                        <div class="icon" style="font-size:clamp(14px, 4vw, 16px);line-height:1" id="ic-chart"></div>Динамика
                    </span>
                    <div style="display:flex;gap:4px">
                        <button class="yr on" id="cb-views" onclick="chartMode('views')" style="padding:clamp(3px, 1vw, 4px) clamp(8px, 2.5vw, 10px);font-size:clamp(10px, 2.8vw, 12px)">Просмотры</button>
                        <button class="yr" id="cb-hours" onclick="chartMode('hours')" style="padding:clamp(3px, 1vw, 4px) clamp(8px, 2.5vw, 10px);font-size:clamp(10px, 2.8vw, 12px)">Часы</button>
                    </div>
                </div>
                <div class="chart-box"><canvas id="c-monthly"></canvas></div>
            </div>

            <div class="card anim-item d3">
                <div style="font-size:clamp(13px, 3.5vw, 15px);font-weight:700;color:var(--text-primary);margin-bottom:clamp(12px, 3.5vw, 16px)">Дни недели</div>
                <div class="chart-box" style="height:160px"><canvas id="c-weekday"></canvas></div>
            </div>

            <div class="card anim-item d3">
                <div style="font-size:clamp(13px, 3.5vw, 15px);font-weight:700;color:var(--text-primary);margin-bottom:clamp(12px, 3.5vw, 16px);display:flex;align-items:center;gap:6px">
                    <div class="icon" style="font-size:clamp(14px, 4vw, 16px);line-height:1" id="ic-flame"></div>Интенсивность
                </div>
                <div class="hm-container">
                    <div class="hm" id="heatmap"></div>
                </div>
                <div class="hm-leg">
                    <span>Меньше</span>
                    <div class="hc"></div><div class="hc h1"></div><div class="hc h2"></div><div class="hc h3"></div><div class="hc h4"></div>
                    <span>Больше</span>
                </div>
            </div>

            <div class="tabs" id="detail-tabs">
                <button class="tab on" data-d="genres" onclick="dTab('genres')"><div class="icon" id="it-gen"></div>Жанры</button>
                <button class="tab" data-d="actors" onclick="dTab('actors')"><div class="icon" id="it-act"></div>Актёры</button>
                <button class="tab" data-d="countries" onclick="dTab('countries')"><div class="icon" id="it-cou"></div>Страны</button>
                <button class="tab" data-d="binges" onclick="dTab('binges')"><div class="icon" id="it-bin"></div>Марафоны</button>
            </div>

            <div class="sec vis" id="ds-genres">
                <div class="card anim-item d1" style="margin-bottom: clamp(10px, 3vw, 12px);">
                    <div class="chart-box" style="height:220px"><canvas id="c-genre"></canvas></div>
                </div>
                <div class="card anim-item d2" id="genres-box"></div>
            </div>
            <div class="sec" id="ds-actors"><div class="card" id="actors-box"></div></div>
            <div class="sec" id="ds-countries"><div class="card" id="countries-box"></div></div>
            <div class="sec" id="ds-binges"><div class="card" id="binges-box"></div></div>
        </div>
        </div>

        <div class="sec" id="sec-group"><div id="group-root"></div></div>

        <div class="sec" id="sec-history">
            <div class="header" style="padding-bottom: 0;">
                <button onclick="closeHistory()" class="tab" style="background:var(--bg-input); color:var(--text-primary); margin-bottom:clamp(10px, 3vw, 12px); display:inline-flex;">
                    <svg viewBox="0 0 24 24" width="16" height="16" style="margin-right:4px;"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></svg> Назад
                </button>
            </div>
            <div class="label" style="padding-top:0;"><div class="icon" id="ic-hist-type"></div><span id="hist-title"></span></div>
            <div id="hist-list" style="padding: 0 clamp(12px, 3.5vw, 16px) clamp(16px, 4.5vw, 20px);"></div>
        </div>
    </div>

<script>
const Icons = {
    moon: '<svg viewBox="0 0 512 512"><path d="M264 480A232 232 0 0132 248c0-94 54-178.28 137.61-214.67a16 16 0 0121.06 21.06C181.07 76.43 176 97.43 176 120c0 110.28 89.72 200 200 200 22.57 0 43.57-5.07 65.61-14.67a16 16 0 0121.06 21.06C426.28 410 342 480 264 480z"/></svg>',
    sun: '<svg viewBox="0 0 512 512"><path d="M256 118a22 22 0 01-22-22V48a22 22 0 0144 0v48a22 22 0 01-22 22zM256 486a22 22 0 01-22-22v-48a22 22 0 0144 0v48a22 22 0 01-22 22zM369.14 164.86a22 22 0 01-15.56-37.55l33.94-33.94a22 22 0 0131.11 31.11l-33.94 33.94a21.93 21.93 0 01-15.55 6.44zM108.92 425.08a22 22 0 01-15.55-37.56l33.94-33.94a22 22 0 1131.11 31.11l-33.94 33.94a21.94 21.94 0 01-15.56 6.45zM464 278h-48a22 22 0 010-44h48a22 22 0 010 44zM96 278H48a22 22 0 010-44h48a22 22 0 010 44zM403.08 425.08a21.94 21.94 0 01-15.56-6.45l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.55 37.56zM142.86 164.86a21.93 21.93 0 01-15.55-6.44l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.56 37.55zM256 358a102 102 0 11102-102 102.12 102.12 0 01-102 102z"/></svg>',
    user: '<svg viewBox="0 0 512 512"><path d="M256 288c79.53 0 144-64.47 144-144S335.53 0 256 0 112 64.47 112 144s64.47 144 144 144zm128 32h-24.1c-30.83 18.66-67.43 28-103.9 28s-73.07-9.34-103.9-28H128c-70.69 0-128 57.31-128 128v56c0 13.25 10.75 24 24 24h464c13.25 0 24-10.75 24-24v-56c0-70.69-57.31-128-128-128z"/></svg>',
    users: '<svg viewBox="0 0 512 512"><path d="M336 256c-20.56 0-40.44-5.06-58.26-14.34-14.73 21-36.42 36.63-61.64 43.68C236.41 298.54 263.26 304 290.5 304h25.4C379.79 304 432 356.21 432 419.86v43.21a20.89 20.89 0 0019.2 20.93h41.6a20.9 20.9 0 0019.2-20.93v-43.21C512 344.21 433.79 256 336 256zM336 224a104 104 0 10-104-104 104.12 104.12 0 00104 104zM201.5 272c-63.53 0-115.2 51.68-115.2 115.21v43.86A20.94 20.94 0 00105.5 452h192a20.94 20.94 0 0019.2-20.93v-43.86C316.7 323.68 265.03 272 201.5 272zM201.5 240A112 112 0 1089.5 128a112.12 112.12 0 00112 112z"/></svg>',
    dash: '<svg viewBox="0 0 512 512"><path d="M200 48H88a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V88a40 40 0 00-40-40zM424 48H312a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V88a40 40 0 00-40-40zM200 272H88a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V312a40 40 0 00-40-40zM424 272H312a40 40 0 00-40 40v112a40 40 0 0040 40h112a40 40 0 0040-40V312a40 40 0 00-40-40z"/></svg>',
    time: '<svg viewBox="0 0 512 512"><path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm96 240h-96a16 16 0 01-16-16V128a16 16 0 0132 0v128h80a16 16 0 010 32z"/></svg>',
    cal: '<svg viewBox="0 0 512 512"><path d="M416 64h-16V48a16 16 0 00-32 0v16H144V48a16 16 0 00-32 0v16H96a64 64 0 00-64 64v320a64 64 0 0064 64h320a64 64 0 0064-64V128a64 64 0 00-64-64zm16 384a16 16 0 01-16 16H96a16 16 0 01-16-16V208h352z"/></svg>',
    tv: '<svg viewBox="0 0 512 512"><path d="M447.86 384H64.14A48.2 48.2 0 0116 335.86V128.14A48.2 48.2 0 0164.14 80h383.72A48.2 48.2 0 01496 128.14v207.72A48.2 48.2 0 01447.86 384zM256 416c-48.87 0-98.39 12-113 18.52-5.71 2.54-9 8.24-9 14.28a15.82 15.82 0 0015.42 16.63c33.09-1.28 70.84-1.43 106.58-1.43 36.31 0 74.45.15 106.58 1.43A15.82 15.82 0 00378 448.8c0-6-3.29-11.74-9-14.28C354.39 428 304.87 416 256 416z"/></svg>',
    film: '<svg viewBox="0 0 512 512"><path d="M436 48H76a44.05 44.05 0 00-44 44v328a44.05 44.05 0 0044 44h360a44.05 44.05 0 0044-44V92a44.05 44.05 0 00-44-44zM136 400H88v-48h48zm0-96H88v-48h48zm0-96H88v-48h48zm0-96H88V64h48zm288 288h-48v-48h48zm0-96h-48v-48h48zm0-96h-48v-48h48zm0-96h-48V64h48z"/></svg>',
    chart: '<svg viewBox="0 0 512 512"><path d="M480 384H64V48a16 16 0 00-32 0v352a16 16 0 0016 16h432a16 16 0 000-32z"/><path d="M112 320h48a16 16 0 0016-16V144a16 16 0 00-16-16h-48a16 16 0 00-16 16v160a16 16 0 0016 16zM240 320h48a16 16 0 0016-16V208a16 16 0 00-16-16h-48a16 16 0 00-16 16v96a16 16 0 0016 16zM368 320h48a16 16 0 0016-16V80a16 16 0 00-16-16h-48a16 16 0 00-16 16v224a16 16 0 0016 16z"/></svg>',
    masks: '<svg viewBox="0 0 512 512"><path d="M374.83 148.5c-20.73-35.41-61.35-43.1-99.28-40.35-6.61.48-12.78 1.15-18.42 1.94-39.77 5.61-75.14-3.23-95.64-38.38A180.78 180.78 0 00122 55.45c-29.35.53-53.72 26-58.84 55.51-14.88 85.54-6.39 173.23 23.32 240.59 13.9 31.5 35.79 53 58 53h.46c24.23-1 43.17-18.4 56.44-48 11.23-25.07 16-53.64 21.05-83.33 3.6-21.05 7.42-43.34 16.89-63.56-5.71-1.39-11.41-2.92-17.15-4.43-15.65-4.14-25-18-20.89-33.65a25.4 25.4 0 0132.88-18.19c23.07 6.4 51.5 15.67 76.5 33.15 48.74 34.11 36.85 91.22 36.85 91.22a201.81 201.81 0 0040.35-71.39c4.27-14.28.32-41.56-13.03-57.87zM102.58 205.15a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42zm86 16.51a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42z"/><path d="M449.62 189.65c-20-43.43-63.85-61.27-111-61.27-23.36 0-46.73 4-66.36 8.78-22.39-17-54-28-80.12-35-15.48-4.2-24.93 9.77-20.89 25.4a25.4 25.4 0 0032.88 18.2c6-1.51 11.75-2.73 17.51-3.66a220.4 220.4 0 01-13 46 179.88 179.88 0 0113.1 19.34c38 52.32 94.61 74.32 153.37 74.32a188 188 0 0021.2-1.22c-.64.12-.52 0-1.11.15a133 133 0 01-17.7 21c-5.26 5-11.45 9.76-18.72 14.18-12.78 7.78-26.24 13-39.73 15.35A177.36 177.36 0 00346.59 455c14.25 31 35.08 51 57.82 51h.51c23.59-1 42.14-18.74 55-48 29.83-67.75 38.64-155.8 23.37-241.64-5.35-29.62-28.77-44.62-33.67-26.71zm-136.2 30.68a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42zm86 0a20.42 20.42 0 1120.42-20.42 20.42 20.42 0 01-20.42 20.42z"/></svg>',
    star: '<svg viewBox="0 0 512 512"><path d="M480 208H328L256 48l-72 160H32l128 104-48 152 144-104 144 104-48-152 128-104z"/></svg>',
    globe: '<svg viewBox="0 0 512 512"><path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm89.15 112.59A151.78 151.78 0 01366 240H288v-87.35a265.41 265.41 0 0157.15 8zM256 80.59A231.87 231.87 0 01283.47 152H228.53A231.87 231.87 0 01256 80.59zM166.85 160.59A265.41 265.41 0 01224 152.65V240h-78A151.78 151.78 0 01166.85 160.59zM80.58 240H146a256.32 256.32 0 000 32H80.58a176 176 0 010-32zm86.27 111.41A151.78 151.78 0 01146 272h78v87.35a265.41 265.41 0 01-57.15-7.94zM256 431.41A231.87 231.87 0 01228.53 360h54.94A231.87 231.87 0 01256 431.41zM345.15 351.41A265.41 265.41 0 01288 359.35V272h78A151.78 151.78 0 01345.15 351.41zM431.42 272H366a256.32 256.32 0 000-32h65.42a176 176 0 010 32z"/></svg>',
    bolt: '<svg viewBox="0 0 512 512"><path d="M312 32h-110a18 18 0 00-17.74 21l32 188H152a18.3 18.3 0 00-14.86 28.92l160 216a18 18 0 0031.57-12.78l-23-189.14H360a18.3 18.3 0 0015-28.84L215 72h97a18 18 0 000-36z"/></svg>',
    flame: '<svg viewBox="0 0 512 512"><path d="M313.29 82.26c-11.42-30.82-50.62-31-62.29.35C227.18 146.42 160 178.68 160 256c0 53 43 96 96 96s96-43 96-96c0-67.62-54-106.82-38.71-173.74zM256 320c-17.64 0-32-14.36-32-32 0-33.15 28.57-55 42-83.39 12 25.15 22 50.18 22 83.39 0 17.64-14.36 32-32 32z"/><path d="M255.8 48c-42.54 0-82.68 20.31-112 54.34-31 36-47.8 84.34-47.8 135.59 0 114.69 93.31 208.07 208 208.07S512 352.62 512 237.93C512 119 407.41 48 255.8 48zm0 366c-88.22 0-160-71.78-160-160 0-41.6 13.92-80.49 40.23-112.5C160.7 171.84 200.56 150 240 150c18.52 0 35.1 4.54 48 13 41.52-32.55 80-28 80 75 0 88.22-71.78 160-160 160z"/></svg>',
    check: '<svg viewBox="0 0 512 512"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29l-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg>'
};

function i(id, name) { const el = document.getElementById(id); if (el) el.innerHTML = Icons[name]; }
document.addEventListener("DOMContentLoaded", () => {
    i('ic-user', 'user'); i('ic-users', 'users'); i('ic-dash', 'dash');
    i('ic-time', 'time'); i('ic-cal', 'cal'); i('ic-tv', 'tv'); i('ic-film', 'film');
    i('ic-chart', 'chart'); i('ic-flame', 'flame');
    i('it-gen', 'masks'); i('it-act', 'star'); i('it-cou', 'globe'); i('it-bin', 'bolt');
});

const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

let D = null, curYear = null, cMode = 'views', isDark = true;
let chM = null, chW = null, chG = null;

function toggleTheme() {
    isDark = !isDark;
    document.body.classList.toggle('light', !isDark);
    document.getElementById('theme-btn').innerHTML = isDark ? Icons.moon : Icons.sun;
    localStorage.setItem('kt', isDark ? 'd' : 'l');
    if (D) renderCharts();
}
(function initTheme() {
    if (localStorage.getItem('kt') === 'l') { isDark = false; document.body.classList.add('light'); }
    document.addEventListener("DOMContentLoaded", () => document.getElementById('theme-btn').innerHTML = isDark ? Icons.moon : Icons.sun);
})();

function cc() {
    const t = isDark ? 'rgba(255,255,255,.45)' : 'rgba(0,0,0,.35)';
    const g = isDark ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.06)';
    return { t, g, a: '#2ecc71', ab: isDark?'rgba(46,204,113,.2)':'rgba(46,204,113,.12)', i: '#60a5fa', ib: isDark?'rgba(96,165,250,.2)':'rgba(96,165,250,.12)' };
}

async function load(year) {
    if (year === undefined || year === null) year = curYear;
    curYear = year;
    document.getElementById('loader').classList.remove('hidden');
    try {
        const p = year && year !== 'all' ? { period_type:'year', period_value: year } : { period_type:'year', period_value: 0 };
        const r = await fetch('/api/webapp/detailed_stats/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...p, init_data: tg?.initData||'' }) });
        const j = await r.json();
        if (!r.ok || j.error) { console.error('API error:', j); alert('Ошибка: '+(j.error||'Неизвестная')); return; }
        D = j;
        render();
    } catch(e) { console.error('Load error:', e); alert('Ошибка сети'); }
    finally { 
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').classList.add('hidden'), 300);
        document.getElementById('app').classList.remove('hidden'); 
    }
}

function render() {
    if (!D?.meta) return;
    const n = D.meta.name || 'Пользователь';
    document.getElementById('user-name').textContent = n;
    
    const u = tg?.initDataUnsafe?.user;
    const avEl = document.getElementById('avatar');
    if (u && u.photo_url) {
        avEl.innerHTML = `<img src="${u.photo_url}" alt="A">`;
    } else {
        avEl.textContent = n.charAt(0).toUpperCase();
    }

    document.getElementById('period-label').textContent = D.summary?.period_label || '';

    renderYears();

    const s = D.summary || {};
    document.getElementById('s-time').textContent  = s.duration_display || '0';
    document.getElementById('s-views').textContent = (s.total_views||0) + ' просмотров';
    document.getElementById('s-act').textContent   = (s.activity_percent||0) + '%';
    document.getElementById('s-daily').textContent = '~' + (s.daily_average_min||0) + ' мин/день';
    document.getElementById('s-ep').textContent    = s.total_episodes || 0;
    document.getElementById('s-ser').textContent   = (s.unique_series||0) + ' сериалов';
    document.getElementById('s-mov').textContent   = s.total_movies || 0;
    document.getElementById('s-uni').textContent   = (s.unique_shows||0) + ' уникальных';

    renderHeatmap();
    renderGenres();
    dTab('genres');
    renderCharts();
    renderGroup();
}

function renderYears() {
    const c = document.getElementById('years');
    const yrs = D.meta?.years || [];
    if (curYear && curYear !== 'all' && yrs.length && !yrs.includes(curYear)) {
        curYear = yrs[0];
    }
    let h = '<button class="yr" onclick="pickYear(\'all\')">Всё время</button>';
    yrs.forEach(y => { h += `<button class="yr" onclick="pickYear(${y})">${y}</button>`; });
    c.innerHTML = h;
    markYear();
}
function markYear() {
    document.querySelectorAll('#years .yr').forEach(b => {
        const v = b.textContent.trim();
        const isAll = !curYear || curYear === 'all';
        b.classList.toggle('on', isAll ? v === 'Всё время' : String(curYear) === v);
    });
}
window.pickYear = y => { curYear = y; markYear(); load(y === 'all' ? 'all' : y); };

function renderHeatmap() {
    const el = document.getElementById('heatmap'); 
    el.innerHTML = '';
    
    if (!D.heatmap?.length) { 
        el.innerHTML = `<div class="empty"><div class="icon">${Icons.cal}</div>Выберите год</div>`; 
        return; 
    }
    
    const yr = curYear && curYear !== 'all' ? curYear : new Date().getFullYear();
    const offset = (new Date(yr, 0, 1).getDay() + 6) % 7;
    
    const totalCells = offset + D.heatmap.length;
    const totalColumns = Math.ceil(totalCells / 7);
    
    el.style.gridTemplateColumns = `repeat(${totalColumns}, 1fr)`;
    
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < offset; i++) { 
        const d = document.createElement('div'); 
        d.className = 'hc'; 
        d.style.opacity = '0'; 
        fragment.appendChild(d); 
    }
    
    D.heatmap.forEach(v => { 
        const d = document.createElement('div'); 
        d.className = 'hc' + (v ? ' h' + v : ''); 
        fragment.appendChild(d); 
    });
    
    el.appendChild(fragment);
}

function renderGenres() {
    const el = document.getElementById('genres-box'); el.innerHTML = '';
    if (!D.genres?.length) { el.innerHTML = `<div class="empty"><div class="icon">${Icons.masks}</div>Нет данных</div>`; return; }
    const mx = Math.max(...D.genres.map(g=>g.minutes),1);
    
    let html = '';
    D.genres.slice(0,7).forEach((g, i) => {
        const w = (g.minutes/mx)*100, h = Math.floor(g.minutes/60), m = g.minutes%60;
        const delay = (i + 1) * 0.05;
        html += `<div class="g-row anim-item" style="animation-delay:${delay}s"><div class="g-hdr"><span class="g-name">${g.name}</span><span class="g-time">${h}ч ${m}м</span></div><div class="g-track"><div class="g-fill" style="width:${w}%"></div></div></div>`;
    });
    el.innerHTML = html;
}

window.dTab = function(t) {
    document.querySelectorAll('#detail-tabs .tab').forEach(b=>b.classList.toggle('on', b.dataset.d===t));
    ['genres','actors','countries','binges'].forEach(s=>document.getElementById('ds-'+s).classList.toggle('vis',s===t));
    if (t==='actors') fillList('actors-box', D.actors, Icons.star, 'просм.');
    if (t==='countries') fillList('countries-box', D.countries, Icons.globe, 'просм.');
    if (t==='binges') fillBinges();
};

function fillList(id, items, ico, unit) {
    const el = document.getElementById(id);
    if (!items?.length) { el.innerHTML = `<div class="empty"><div class="icon">${ico}</div>Нет данных</div>`; return; }
    
    let html = '';
    items.forEach((it, i) => {
        const cnt = it.count || it.views || '';
        const sub = it.shows ? `${it.shows} шоу` : (it.sub || '');
        const lbl = unit ? `${cnt} ${unit}` : cnt;
        const delay = (i + 1) * 0.05;
        
        let visual = it.emoji ? `<span style="font-size:clamp(16px,4.5vw,20px);line-height:1;margin-right:4px">${it.emoji}</span>` : `<div class="icon">${ico}</div>`;
        
        html += `<div class="li anim-item" style="animation-delay:${delay}s"><div class="li-l"><span class="li-rank">${i+1}</span><div><div class="li-name">${visual} ${it.name}</div>${sub?`<div class="li-sub">${sub}</div>`:''}</div></div><span class="li-r">${lbl}</span></div>`;
    });
    el.innerHTML = html;
}

function fillBinges() {
    const el = document.getElementById('binges-box');
    if (!D.binges?.length) { el.innerHTML = `<div class="empty"><div class="icon">${Icons.bolt}</div>Нет марафонов</div>`; return; }
    
    let html = '';
    D.binges.forEach((b, i) => {
        const delay = (i + 1) * 0.05;
        const ico = b.tier==='marathon' ? Icons.flame : Icons.bolt;
        html += `<div class="li anim-item" style="animation-delay:${delay}s"><div class="li-l"><span class="li-rank"><div class="icon" style="font-size:clamp(16px,4.5vw,20px);line-height:1">${ico}</div></span><div><div class="li-name">${b.show_title}</div><div class="li-sub">${b.date}</div></div></div><span class="li-r">${b.count} эп.</span></div>`;
    });
    el.innerHTML = html;
}

function renderCharts() { renderMonthly(); renderWeekday(); renderDonut(); }

const fSizeAx = Math.max(10, Math.min(14, window.innerWidth * 0.03));
const fSizeTi = Math.max(11, Math.min(16, window.innerWidth * 0.035));

function renderMonthly() {
    const ctx = document.getElementById('c-monthly');
    if (chM) chM.destroy();
    const ch = D.monthly_chart; if (!ch?.labels?.length) return;
    const c = cc(), isV = cMode==='views', ds = isV?ch.views:ch.hours;
    chM = new Chart(ctx, { 
        type:'line', 
        data:{ 
            labels:ch.labels, 
            datasets:[{ 
                data:ds, 
                backgroundColor:c.ab, 
                borderColor:c.a, 
                borderWidth:2, 
                tension:0.4, 
                fill:true,
                pointBackgroundColor: isDark ? '#1b1f26' : '#ffffff',
                pointBorderColor: c.a,
                pointRadius: 3,
                pointHoverRadius: 5
            }] 
        },
        options:{ 
            responsive:true, 
            maintainAspectRatio:false, 
            plugins:{ legend:{display:false} },
            interaction: { mode: 'index', intersect: false },
            scales:{ 
                x:{ title:{display:true,text:'Месяц',color:c.t,font:{size:fSizeTi,weight:'600',family:'inherit'}}, ticks:{color:c.t,font:{size:fSizeAx}}, grid:{display:false} },
                y:{ title:{display:true,text:isV?'Просмотры':'Часы',color:c.t,font:{size:fSizeTi,weight:'600',family:'inherit'}}, ticks:{color:c.t,font:{size:fSizeAx}}, grid:{color:c.g}, beginAtZero:true } 
            } 
        } 
    });
}
function renderWeekday() {
    const ctx = document.getElementById('c-weekday');
    if (chW) chW.destroy();
    const ch = D.weekday_chart; if (!ch?.labels?.length) return;
    const c = cc();
    chW = new Chart(ctx, { type:'bar', data:{ labels:ch.labels, datasets:[{ data:ch.data,
        backgroundColor:ch.data.map((_,i)=>i>=5?c.ib:c.ab), borderColor:ch.data.map((_,i)=>i>=5?c.i:c.a), borderWidth:1.5, borderRadius:4, borderSkipped:false }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
            scales:{ x:{ title:{display:true,text:'День недели',color:c.t,font:{size:fSizeTi,weight:'600',family:'inherit'}}, ticks:{color:c.t,font:{size:fSizeAx}}, grid:{display:false} },
                     y:{ title:{display:true,text:'Просмотры',color:c.t,font:{size:fSizeTi,weight:'600',family:'inherit'}}, ticks:{color:c.t,font:{size:fSizeAx}}, grid:{color:c.g}, beginAtZero:true } } } });
}
function renderDonut() {
    const ctx = document.getElementById('c-genre');
    if (chG) chG.destroy();
    if (!D.genres?.length) return;
    const c = cc(), pal = ['#2ecc71','#3498db','#e74c3c','#1abc9c','#f39c12','#9b59b6','#e67e22','#ecf0f1'], top = D.genres.slice(0,6);
    chG = new Chart(ctx, { 
        type:'doughnut', 
        data:{ 
            labels:top.map(g => {
                const h = Math.floor(g.minutes / 60);
                const m = g.minutes % 60;
                return `${g.name} (${h}ч ${m}м)`;
            }), 
            datasets:[{ 
                data:top.map(g => g.minutes), 
                backgroundColor:top.map((_,i)=>pal[i%pal.length]), 
                borderWidth:0, spacing:3 
            }] 
        },
        options:{ 
            responsive:true, 
            maintainAspectRatio:false, 
            cutout:'65%', 
            plugins:{ 
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const mins = context.parsed;
                            const h = Math.floor(mins / 60);
                            const m = mins % 60;
                            return ` ${h}ч ${m}м`;
                        }
                    }
                },
                legend:{ position:'right', labels:{ color:c.t, font:{size:fSizeTi,family:'inherit'}, padding:8, usePointStyle:true, pointStyleWidth:10 } } 
            } 
        } 
    });
}
window.chartMode = m => { cMode = m; document.getElementById('cb-views').classList.toggle('on',m==='views'); document.getElementById('cb-hours').classList.toggle('on',m==='hours'); renderMonthly(); };

window.mainTab = function(t) {
    document.querySelectorAll('#main-tabs .tab').forEach(b=>b.classList.toggle('on', b.dataset.tab===t));
    document.getElementById('sec-personal').classList.toggle('vis', t==='personal');
    document.getElementById('sec-group').classList.toggle('vis', t==='group');
};

window.openHistory = function(type) {
    document.getElementById('main-tabs').classList.add('hidden');
    document.getElementById('years').classList.add('hidden');
    document.getElementById('sec-personal').classList.remove('vis');
    document.getElementById('sec-group').classList.remove('vis');
    
    const secHist = document.getElementById('sec-history');
    secHist.classList.add('vis');
    
    if (tg && tg.BackButton) {
        tg.BackButton.show();
        tg.BackButton.onClick(window.closeHistory);
    }
    
    const el = document.getElementById('hist-list');
    el.innerHTML = '';
    
    let data;
    if (type === 'all') {
        data = [...D.history_movies, ...D.history_episodes].sort((a, b) => {
            if (b.view_date !== a.view_date) return b.view_date.localeCompare(a.view_date);
            return (b.show_id + (b.episode_number || 0)) - (a.show_id + (a.episode_number || 0));
        });
        document.getElementById('hist-title').textContent = 'Вся история просмотров';
        document.getElementById('ic-hist-type').innerHTML = Icons.dash;
    } else {
        data = type === 'movies' ? D.history_movies : D.history_episodes;
        document.getElementById('hist-title').textContent = type === 'movies' ? 'Просмотренные фильмы' : 'Просмотренные эпизоды';
        document.getElementById('ic-hist-type').innerHTML = type === 'movies' ? Icons.film : Icons.tv;
    }
    
    if (!data || !data.length) {
        el.innerHTML = `<div class="empty"><div class="icon">${type === 'movies' ? Icons.film : Icons.tv}</div>Нет просмотров</div>`;
        return;
    }
    
    let html = '<div class="card" style="margin:0; padding:0; overflow:hidden;">';
    data.forEach((item, idx) => {
        const delay = Math.min((idx + 1) * 0.02, 0.5); 
        
        let metaHtml = '';
        if (item.season_number !== undefined && item.season_number > 0) {
            const s = item.season_number;
            const e = item.episode_number < 10 ? '0'+item.episode_number : item.episode_number;
            metaHtml += `<span class="hist-badge">s${s}e${e}</span>`;
            
            if (item.user_rating) {
                const rVal = Number.isInteger(item.user_rating) ? item.user_rating : item.user_rating.toFixed(1);
                metaHtml += `<span class="rating-badge">${Icons.star}${rVal}</span>`;
            }
            
            if (item.user_show_rating) {
                const rsVal = Number.isInteger(item.user_show_rating) ? item.user_show_rating : item.user_show_rating.toFixed(1);
                metaHtml += `<span class="rating-badge show-lvl">(${rsVal})</span>`;
            }
        } else {
            if (item.user_rating) {
                const rVal = Number.isInteger(item.user_rating) ? item.user_rating : item.user_rating.toFixed(1);
                metaHtml += `<span class="rating-badge">${Icons.star}${rVal}</span>`;
            }
        }

        const origTitle = item.show__original_title && item.show__original_title !== item.show__title 
            ? `<div class="hist-orig">${item.show__original_title}</div>` 
            : '';
            
        const yearSuffix = item.show__year ? ` <span style="color:var(--text-muted); font-weight:400;">(${item.show__year})</span>` : '';
        const poster = item.poster_url 
            ? `<img src="${item.poster_url}" class="hist-poster" alt="poster" loading="lazy" onerror="this.style.display='none'">` 
            : `<div class="hist-poster"></div>`;

        html += `
        <div class="hist-item anim-item" style="animation-delay:${delay}s;">
            ${poster}
            <div class="hist-info">
                <div class="hist-title">${item.show__title}${yearSuffix}</div>
                ${origTitle}
                <div class="hist-meta">${metaHtml}<span>${item.view_date}</span></div>
            </div>
        </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
    window.scrollTo(0, 0);
};

window.closeHistory = function() {
    if (tg && tg.BackButton) {
        tg.BackButton.hide();
        tg.BackButton.offClick(window.closeHistory);
    }
    document.getElementById('main-tabs').classList.remove('hidden');
    document.getElementById('years').classList.remove('hidden');
    document.getElementById('sec-history').classList.remove('vis');
    
    const curTab = document.querySelector('#main-tabs .tab.on').dataset.tab;
    mainTab(curTab);
};

function renderGroup() {
    const el = document.getElementById('group-root');
    if (!D.group) { el.innerHTML = `<div class="card"><div class="empty"><div class="icon" style="font-size:clamp(28px, 8vw, 36px);line-height:1">${Icons.users}</div>Вы не состоите в группе</div></div>`; return; }
    const g = D.group, p = D.summary;

    const rows = [
        { lb:'Просмотры', i:Icons.tv, y:p.total_views, gv:g.total_views },
        { lb:'Эпизоды', i:Icons.film, y:p.total_episodes, gv:g.total_episodes },
        { lb:'Фильмы', i:Icons.time, y:p.total_movies, gv:g.total_movies },
        { lb:'Уникальных', i:Icons.star, y:p.unique_shows, gv:g.unique_shows },
    ];
    let hasDiff = false;
    const cmpH = rows.map((r, idx) => {
        const d = r.y - r.gv;
        let dh;
        if (d===0) dh = `<span class="cmp-d d-eq"><div class="icon" style="font-size:clamp(10px, 2.8vw, 13px);display:inline-block;vertical-align:middle;line-height:1">${Icons.check}</div> Мэтч</span>`;
        else { hasDiff = true; dh = `<span class="cmp-d ${d>0?'d-up':'d-dn'}">${d>0?'+':''}${d}</span>`; }
        return `<div class="cmp anim-item" style="animation-delay:${(idx+1)*0.05}s"><span class="cmp-lb"><div class="icon" style="font-size:clamp(14px, 4vw, 18px);line-height:1">${r.i}</div>${r.lb}</span><div class="cmp-vs"><span class="cmp-v cmp-you">${r.y}</span><span style="color:var(--text-muted);font-size:clamp(10px, 2.8vw, 12px)">vs</span><span class="cmp-v cmp-grp">${r.gv}</span>${dh}</div></div>`;
    }).join('');

    const mx = Math.max(...g.members.map(m=>m.views),1);
    const mbH = g.members.map((m, idx) => `<div class="mb anim-item" style="animation-delay:${(idx+1)*0.05}s"><span class="mb-n">${m.name}</span><div class="mb-t"><div class="mb-f" style="width:${(m.views/mx)*100}%"></div></div><span class="mb-c">${m.views}</span></div>`).join('');

    let gGenH = '';
    if (g.genres?.length) {
        const gm = Math.max(...g.genres.map(x=>x.minutes),1);
        gGenH = `<div class="label"><div class="icon" style="font-size:clamp(13px, 3.5vw, 16px);line-height:1">${Icons.masks}</div>Жанры группы</div><div class="card anim-item d3">` + g.genres.slice(0,5).map((x, idx) => {
            const w=(x.minutes/gm)*100, h=Math.floor(x.minutes/60), m=x.minutes%60;
            return `<div class="g-row anim-item" style="animation-delay:${(idx+1)*0.05}s"><div class="g-hdr"><span class="g-name">${x.name}</span><span class="g-time">${h}ч ${m}м</span></div><div class="g-track"><div class="g-fill" style="width:${w}%;background:var(--info)"></div></div></div>`;
        }).join('') + '</div>';
    }

    el.innerHTML = `
        <div class="card anim-item"><div style="display:flex;align-items:center;gap:12px"><div class="icon" style="font-size:clamp(22px, 6vw, 26px);line-height:1">${Icons.users}</div><div><div style="font-size:clamp(15px, 4vw, 18px);font-weight:700;color:var(--text-primary)">${g.group_name}</div><div style="font-size:clamp(11px, 3vw, 14px);color:var(--text-muted)">${g.members_count} участников · ${g.duration_display}</div></div></div></div>
        <div class="label"><div class="icon" style="font-size:clamp(13px, 3.5vw, 16px);line-height:1">${Icons.chart}</div>Вы vs Группа</div>
        <div class="card anim-item d1">
            <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)"><span style="font-size:clamp(11px, 3vw, 14px);font-weight:700;color:var(--accent)">👤 Вы</span><span style="font-size:clamp(11px, 3vw, 14px);font-weight:700;color:var(--info)">👥 Группа</span></div>
            ${!hasDiff?`<div style="text-align:center;padding:12px 0;font-size:clamp(13px, 3.5vw, 16px);color:var(--accent);font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px"><div class="icon" style="font-size:clamp(16px, 4.5vw, 20px);line-height:1">${Icons.check}</div> Полный мэтч!</div>`:''}
            ${cmpH}
        </div>
        <div class="label"><div class="icon" style="font-size:clamp(13px, 3.5vw, 16px);line-height:1">${Icons.user}</div>Участники</div>
        <div class="card anim-item d2">${mbH}</div>
        ${gGenH}`;
}

load();
</script>
</body>
</html>