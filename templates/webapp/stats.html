<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KinoStats</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-main: #1c202b;
            --bg-card: #232836;
            --bg-input: rgba(255,255,255,0.08);
            --border: rgba(120,130,140,0.13);
            --text-primary: rgba(255,255,255,0.87);
            --text-secondary: rgba(255,255,255,0.65);
            --text-muted: rgba(120,130,140,1);
            --accent: #02b875;
            --accent-dim: rgba(2,184,117,0.15);
            --success: #6cc788;
            --info: #6887ff;
            --warning: #f77a99;
            --danger: #ef1960;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        .light {
            --bg-main: #f5f5f7;
            --bg-card: #ffffff;
            --bg-input: rgba(0,0,0,0.04);
            --border: rgba(0,0,0,0.07);
            --text-primary: rgba(0,0,0,0.87);
            --text-secondary: rgba(0,0,0,0.6);
            --text-muted: rgba(0,0,0,0.38);
            --shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-main);
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 28px;
            transition: background .25s, color .25s;
        }

        /* ===== CARD ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin: 0 16px 12px;
            box-shadow: var(--shadow);
            transition: background .25s, border-color .25s;
        }

        /* ===== HEADER ===== */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 16px 16px 6px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--accent); display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; color: #fff; flex-shrink: 0;
        }
        .header-name { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .header-sub  { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
        .theme-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-input); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: background .2s;
        }
        .theme-btn:active { transform: scale(.92); }

        /* ===== PILL TABS ===== */
        .tabs { display: flex; gap: 6px; padding: 8px 16px 4px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            flex-shrink: 0; padding: 8px 16px; border-radius: 10px;
            font-size: 13px; font-weight: 600; white-space: nowrap;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-muted); cursor: pointer; transition: all .2s;
        }
        .tab.on { background: var(--accent); color: #fff; border-color: var(--accent); }
        .tab:not(.on):active { background: var(--accent-dim); }

        /* ===== YEAR PILLS ===== */
        .years { display: flex; gap: 4px; padding: 4px 16px 8px; overflow-x: auto; }
        .years::-webkit-scrollbar { display: none; }
        .yr {
            flex-shrink: 0; padding: 5px 13px; border-radius: 8px;
            font-size: 12px; font-weight: 600;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-muted); cursor: pointer; transition: all .2s;
        }
        .yr.on { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        /* ===== SECTION LABEL ===== */
        .label {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: .5px; color: var(--text-muted); padding: 12px 16px 4px;
        }

        /* ===== STAT GRID ===== */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 16px 12px; }
        .stat {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); transition: background .25s;
        }
        .stat-icon  { font-size: 20px; margin-bottom: 4px; }
        .stat-val   { font-size: 22px; font-weight: 800; color: var(--text-primary); line-height: 1.1; }
        .stat-lbl   { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: .3px; margin-top: 2px; }
        .stat-sub   { font-size: 11px; color: var(--accent); margin-top: 4px; font-weight: 500; }

        /* ===== GENRE BARS ===== */
        .g-row { margin-bottom: 10px; }
        .g-hdr { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .g-name { color: var(--text-primary); }
        .g-time { color: var(--text-muted); }
        .g-track { height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .g-fill  { height: 100%; border-radius: 3px; background: linear-gradient(90deg,var(--accent),var(--success)); transition: width .5s ease; }

        /* ===== LIST ROWS ===== */
        .li { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .li:last-child { border: none; }
        .li-l { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
        .li-r { font-size: 13px; font-weight: 700; color: var(--accent); flex-shrink: 0; margin-left: 8px; }
        .li-rank { font-size: 11px; font-weight: 700; color: var(--text-muted); width: 20px; text-align: center; flex-shrink: 0; }
        .li-name { font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .li-sub  { font-size: 10px; color: var(--text-muted); }

        /* ===== HEATMAP ===== */
        .hm { display: grid; grid-template-rows: repeat(7, 9px); grid-auto-flow: column; gap: 2px; overflow-x: auto; justify-content: center; }
        .hc { width: 9px; height: 9px; border-radius: 2px; background: var(--bg-input); }
        .h1 { background: #0e4429; } .h2 { background: #006d32; } .h3 { background: #26a641; } .h4 { background: #39d353; }
        .light .h1 { background: #9be9a8; } .light .h2 { background: #40c463; } .light .h3 { background: #30a14e; } .light .h4 { background: #216e39; }
        .hm-leg { display: flex; align-items: center; gap: 4px; justify-content: flex-end; margin-top: 8px; font-size: 10px; color: var(--text-muted); }
        .hm-leg .hc { width: 10px; height: 10px; }

        /* ===== CHART ===== */
        .chart-box { position: relative; width: 100%; height: 200px; }

        /* ===== GROUP COMPARE ===== */
        .cmp { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .cmp:last-child { border: none; }
        .cmp-lb { font-size: 12px; color: var(--text-muted); font-weight: 500; }
        .cmp-vs { display: flex; gap: 12px; align-items: center; }
        .cmp-v  { font-size: 13px; font-weight: 700; text-align: right; min-width: 44px; }
        .cmp-you { color: var(--accent); }
        .cmp-grp { color: var(--info); }
        .cmp-d  { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
        .d-up   { background: rgba(2,184,117,.15); color: var(--accent); }
        .d-dn   { background: rgba(239,25,96,.15); color: var(--danger); }
        .d-eq   { background: var(--accent-dim); color: var(--accent); }

        /* ===== MEMBER BAR ===== */
        .mb { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .mb-n { font-size: 12px; font-weight: 600; color: var(--text-primary); width: 80px; text-align: right; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mb-t { flex: 1; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .mb-f { height: 100%; border-radius: 4px; background: var(--accent); transition: width .4s ease; }
        .mb-c { font-size: 11px; font-weight: 700; color: var(--text-muted); width: 36px; flex-shrink: 0; }

        /* ===== EMPTY ===== */
        .empty { text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px; }
        .empty-ico { font-size: 32px; margin-bottom: 8px; }

        /* ===== LOADER ===== */
        .loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: var(--bg-main); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== VISIBILITY ===== */
        .sec { display: none; }
        .sec.vis { display: block; }
        .hidden { display: none !important; }

        /* ===== ANIM ===== */
        @keyframes up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fu { animation: up .35s ease forwards; }
        .d1 { animation-delay: .04s; opacity: 0; }
        .d2 { animation-delay: .08s; opacity: 0; }
        .d3 { animation-delay: .12s; opacity: 0; }
        .d4 { animation-delay: .16s; opacity: 0; }
    </style>
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>

    <div id="app" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="avatar" id="avatar">?</div>
                <div>
                    <div class="header-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                    <div class="header-sub" id="period-label"></div>
                </div>
            </div>
            <button class="theme-btn" id="theme-btn" onclick="toggleTheme()">üåô</button>
        </div>

        <!-- Main tabs -->
        <div class="tabs" id="main-tabs">
            <button class="tab on" data-tab="personal" onclick="mainTab('personal')">üë§ –õ–∏—á–Ω–∞—è</button>
            <button class="tab" data-tab="group" onclick="mainTab('group')">üë• –ì—Ä—É–ø–ø–∞</button>
        </div>

        <!-- Year pills -->
        <div class="years" id="years"></div>

        <!-- ======== PERSONAL ======== -->
        <div class="sec vis" id="sec-personal">
            <div class="label">üìä –û–±–∑–æ—Ä</div>
            <div class="grid">
                <div class="stat fu d1">
                    <div class="stat-icon">üé¨</div>
                    <div class="stat-val" id="s-time">‚Äî</div>
                    <div class="stat-lbl">–í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
                    <div class="stat-sub" id="s-views"></div>
                </div>
                <div class="stat fu d2">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-val" id="s-act">0%</div>
                    <div class="stat-lbl">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                    <div class="stat-sub" id="s-daily"></div>
                </div>
                <div class="stat fu d3">
                    <div class="stat-icon">üì∫</div>
                    <div class="stat-val" id="s-ep">0</div>
                    <div class="stat-lbl">–≠–ø–∏–∑–æ–¥–æ–≤</div>
                    <div class="stat-sub" id="s-ser"></div>
                </div>
                <div class="stat fu d4">
                    <div class="stat-icon">üéûÔ∏è</div>
                    <div class="stat-val" id="s-mov">0</div>
                    <div class="stat-lbl">–§–∏–ª—å–º–æ–≤</div>
                    <div class="stat-sub" id="s-uni"></div>
                </div>
            </div>

            <!-- Monthly chart -->
            <div class="card fu d2">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-size:13px;font-weight:700;color:var(--text-primary)">üìà –î–∏–Ω–∞–º–∏–∫–∞</span>
                    <div style="display:flex;gap:4px">
                        <button class="yr on" id="cb-views" onclick="chartMode('views')" style="padding:4px 10px;font-size:11px">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</button>
                        <button class="yr" id="cb-hours" onclick="chartMode('hours')" style="padding:4px 10px;font-size:11px">–ß–∞—Å—ã</button>
                    </div>
                </div>
                <div class="chart-box"><canvas id="c-monthly"></canvas></div>
            </div>

            <!-- Weekday chart -->
            <div class="card fu d3">
                <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px">üìÖ –î–Ω–∏ –Ω–µ–¥–µ–ª–∏</div>
                <div class="chart-box" style="height:160px"><canvas id="c-weekday"></canvas></div>
            </div>

            <!-- Heatmap -->
            <div class="card fu d3">
                <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:10px">üî• –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</div>
                <div class="hm" id="heatmap"></div>
                <div class="hm-leg">
                    <span>–ú–µ–Ω—å—à–µ</span>
                    <div class="hc"></div><div class="hc h1"></div><div class="hc h2"></div><div class="hc h3"></div><div class="hc h4"></div>
                    <span>–ë–æ–ª—å—à–µ</span>
                </div>
            </div>

            <!-- Detail tabs -->
            <div class="tabs" id="detail-tabs">
                <button class="tab on" data-d="genres"    onclick="dTab('genres')">üé≠ –ñ–∞–Ω—Ä—ã</button>
                <button class="tab"    data-d="actors"    onclick="dTab('actors')">‚≠ê –ê–∫—Ç—ë—Ä—ã</button>
                <button class="tab"    data-d="countries" onclick="dTab('countries')">üåç –°—Ç—Ä–∞–Ω—ã</button>
                <button class="tab"    data-d="binges"    onclick="dTab('binges')">üèÉ –ú–∞—Ä–∞—Ñ–æ–Ω—ã</button>
            </div>

            <div class="sec vis" id="ds-genres"><div class="card" id="genres-box"></div></div>
            <div class="sec" id="ds-actors"><div class="card" id="actors-box"></div></div>
            <div class="sec" id="ds-countries"><div class="card" id="countries-box"></div></div>
            <div class="sec" id="ds-binges"><div class="card" id="binges-box"></div></div>

            <!-- Genre donut -->
            <div class="card fu d4">
                <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px">üé≠ –ñ–∞–Ω—Ä—ã ‚Äî –¥–æ–ª—è</div>
                <div class="chart-box" style="height:220px"><canvas id="c-genre"></canvas></div>
            </div>
        </div>

        <!-- ======== GROUP ======== -->
        <div class="sec" id="sec-group"><div id="group-root"></div></div>
    </div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

let D = null, curYear = null, cMode = 'views', isDark = true;
let chM = null, chW = null, chG = null;

/* ‚îÄ‚îÄ theme ‚îÄ‚îÄ */
function toggleTheme() {
    isDark = !isDark;
    document.body.classList.toggle('light', !isDark);
    document.getElementById('theme-btn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('kt', isDark ? 'd' : 'l');
    if (D) renderCharts();
}
(function initTheme() {
    if (localStorage.getItem('kt') === 'l') { isDark = false; document.body.classList.add('light'); document.getElementById('theme-btn').textContent = '‚òÄÔ∏è'; }
})();

function cc() {
    const t = isDark ? 'rgba(255,255,255,.45)' : 'rgba(0,0,0,.35)';
    const g = isDark ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.06)';
    return { t, g, a: '#02b875', ab: isDark?'rgba(2,184,117,.2)':'rgba(2,184,117,.12)', i: '#6887ff', ib: isDark?'rgba(104,135,255,.2)':'rgba(104,135,255,.12)' };
}

/* ‚îÄ‚îÄ load ‚îÄ‚îÄ */
async function load(year) {
    if (year === undefined || year === null) year = curYear;
    curYear = year;
    document.getElementById('loader').classList.remove('hidden');
    try {
        const p = year && year !== 'all' ? { period_type:'year', period_value: year } : { period_type:'year', period_value: 0 };
        const r = await fetch('/api/webapp/detailed_stats/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...p, init_data: tg?.initData||'' }) });
        const j = await r.json();
        if (!r.ok || j.error) { console.error('API error:', j); alert('–û—à–∏–±–∫–∞: '+(j.error||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è')); return; }
        D = j;
        render();
    } catch(e) { console.error('Load error:', e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    finally { document.getElementById('loader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); }
}

/* ‚îÄ‚îÄ render ‚îÄ‚îÄ */
function render() {
    if (!D?.meta) return;
    const n = D.meta.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('user-name').textContent = n;
    document.getElementById('avatar').textContent = n.charAt(0).toUpperCase();
    document.getElementById('period-label').textContent = D.summary?.period_label || '';

    renderYears();

    const s = D.summary || {};
    document.getElementById('s-time').textContent  = s.duration_display || '0';
    document.getElementById('s-views').textContent = (s.total_views||0) + ' –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤';
    document.getElementById('s-act').textContent   = (s.activity_percent||0) + '%';
    document.getElementById('s-daily').textContent = '~' + (s.daily_average_min||0) + ' –º–∏–Ω/–¥–µ–Ω—å';
    document.getElementById('s-ep').textContent    = s.total_episodes || 0;
    document.getElementById('s-ser').textContent   = (s.unique_series||0) + ' —Å–µ—Ä–∏–∞–ª–æ–≤';
    document.getElementById('s-mov').textContent   = s.total_movies || 0;
    document.getElementById('s-uni').textContent   = (s.unique_shows||0) + ' —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö';

    renderHeatmap();
    renderGenres();
    dTab('genres');
    renderCharts();
    renderGroup();
}

/* ‚îÄ‚îÄ years ‚îÄ‚îÄ */
function renderYears() {
    const c = document.getElementById('years');
    const yrs = D.meta?.years || [];
    // If current year not in list, fall back to first available or 'all'
    if (curYear && curYear !== 'all' && yrs.length && !yrs.includes(curYear)) {
        curYear = yrs[0];
    }
    let h = '<button class="yr" onclick="pickYear(\'all\')">–í—Å—ë –≤—Ä–µ–º—è</button>';
    yrs.forEach(y => { h += `<button class="yr" onclick="pickYear(${y})">${y}</button>`; });
    c.innerHTML = h;
    markYear();
}
function markYear() {
    document.querySelectorAll('#years .yr').forEach(b => {
        const v = b.textContent.trim();
        const isAll = !curYear || curYear === 'all';
        b.classList.toggle('on', isAll ? v === '–í—Å—ë –≤—Ä–µ–º—è' : String(curYear) === v);
    });
}
window.pickYear = y => { curYear = y; markYear(); load(y === 'all' ? 'all' : y); };

/* ‚îÄ‚îÄ heatmap ‚îÄ‚îÄ */
function renderHeatmap() {
    const el = document.getElementById('heatmap'); el.innerHTML = '';
    if (!D.heatmap?.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">üìÖ</div>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –¥–ª—è –∫–∞—Ä—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>'; return; }
    const yr = curYear && curYear !== 'all' ? curYear : new Date().getFullYear();
    const offset = (new Date(yr, 0, 1).getDay() + 6) % 7; // Mon=0
    for (let i = 0; i < offset; i++) { const d = document.createElement('div'); d.className = 'hc'; d.style.visibility = 'hidden'; el.appendChild(d); }
    D.heatmap.forEach(v => { const d = document.createElement('div'); d.className = 'hc'+(v?' h'+v:''); el.appendChild(d); });
}

/* ‚îÄ‚îÄ genres ‚îÄ‚îÄ */
function renderGenres() {
    const el = document.getElementById('genres-box'); el.innerHTML = '';
    if (!D.genres?.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">üé≠</div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
    const mx = Math.max(...D.genres.map(g=>g.minutes),1);
    D.genres.slice(0,7).forEach(g => {
        const w = (g.minutes/mx)*100, h = Math.floor(g.minutes/60), m = g.minutes%60;
        el.innerHTML += `<div class="g-row"><div class="g-hdr"><span class="g-name">${g.name}</span><span class="g-time">${h}—á ${m}–º</span></div><div class="g-track"><div class="g-fill" style="width:${w}%"></div></div></div>`;
    });
}

/* ‚îÄ‚îÄ detail tabs ‚îÄ‚îÄ */
window.dTab = function(t) {
    document.querySelectorAll('#detail-tabs .tab').forEach(b=>b.classList.toggle('on', b.dataset.d===t));
    ['genres','actors','countries','binges'].forEach(s=>document.getElementById('ds-'+s).classList.toggle('vis',s===t));
    if (t==='actors') fillList('actors-box', D.actors, '‚≠ê', '–ø—Ä–æ—Å–º.');
    if (t==='countries') fillList('countries-box', D.countries, '', '–ø—Ä–æ—Å–º.');
    if (t==='binges') fillBinges();
};
function fillList(id, items, emo, unit) {
    const el = document.getElementById(id);
    if (!items?.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">üîç</div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
    el.innerHTML = items.map((it,i) => {
        const cnt = it.count || it.views || '';
        const sub = it.shows ? `${it.shows} —à–æ—É` : (it.sub || '');
        const lbl = unit ? `${cnt} ${unit}` : cnt;
        return `<div class="li"><div class="li-l"><span class="li-rank">${i+1}</span><div><div class="li-name">${it.emoji||emo} ${it.name}</div>${sub?`<div class="li-sub">${sub}</div>`:''}</div></div><span class="li-r">${lbl}</span></div>`;
    }).join('');
}
function fillBinges() {
    const el = document.getElementById('binges-box');
    if (!D.binges?.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">üèÉ</div>–ù–µ—Ç –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤</div>'; return; }
    el.innerHTML = D.binges.map(b => {
        const e = b.tier==='marathon'?'üèÜ':b.tier==='binge'?'üî•':'‚ö°';
        return `<div class="li"><div class="li-l"><span class="li-rank">${e}</span><div><div class="li-name">${b.show_title}</div><div class="li-sub">${b.date}</div></div></div><span class="li-r">${b.count} —ç–ø.</span></div>`;
    }).join('');
}

/* ‚îÄ‚îÄ charts ‚îÄ‚îÄ */
function renderCharts() { renderMonthly(); renderWeekday(); renderDonut(); }

function renderMonthly() {
    const ctx = document.getElementById('c-monthly');
    if (chM) chM.destroy();
    const ch = D.monthly_chart; if (!ch?.labels?.length) return;
    const c = cc(), isV = cMode==='views', ds = isV?ch.views:ch.hours;
    chM = new Chart(ctx, { type:'bar', data:{ labels:ch.labels, datasets:[{ data:ds, backgroundColor:c.ab, borderColor:c.a, borderWidth:1.5, borderRadius:4, borderSkipped:false }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
            scales:{ x:{ title:{display:true,text:'–ú–µ—Å—è—Ü',color:c.t,font:{size:11,weight:'600'}}, ticks:{color:c.t,font:{size:10}}, grid:{display:false} },
                     y:{ title:{display:true,text:isV?'–ü—Ä–æ—Å–º–æ—Ç—Ä—ã':'–ß–∞—Å—ã',color:c.t,font:{size:11,weight:'600'}}, ticks:{color:c.t,font:{size:10}}, grid:{color:c.g}, beginAtZero:true } } } });
}
function renderWeekday() {
    const ctx = document.getElementById('c-weekday');
    if (chW) chW.destroy();
    const ch = D.weekday_chart; if (!ch?.labels?.length) return;
    const c = cc();
    chW = new Chart(ctx, { type:'bar', data:{ labels:ch.labels, datasets:[{ data:ch.data,
        backgroundColor:ch.data.map((_,i)=>i>=5?c.ib:c.ab), borderColor:ch.data.map((_,i)=>i>=5?c.i:c.a), borderWidth:1.5, borderRadius:4, borderSkipped:false }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
            scales:{ x:{ title:{display:true,text:'–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏',color:c.t,font:{size:11,weight:'600'}}, ticks:{color:c.t,font:{size:10}}, grid:{display:false} },
                     y:{ title:{display:true,text:'–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',color:c.t,font:{size:11,weight:'600'}}, ticks:{color:c.t,font:{size:10}}, grid:{color:c.g}, beginAtZero:true } } } });
}
function renderDonut() {
    const ctx = document.getElementById('c-genre');
    if (chG) chG.destroy();
    if (!D.genres?.length) return;
    const c = cc(), pal = ['#02b875','#6887ff','#f77a99','#6cc788','#f0ad4e','#5bc0de','#ef1960','#9b59b6'], top = D.genres.slice(0,6);
    chG = new Chart(ctx, { type:'doughnut', data:{ labels:top.map(g=>g.name), datasets:[{ data:top.map(g=>g.count), backgroundColor:top.map((_,i)=>pal[i%pal.length]), borderWidth:0, spacing:2 }] },
        options:{ responsive:true, maintainAspectRatio:false, cutout:'55%', plugins:{ legend:{ position:'right', labels:{ color:c.t, font:{size:11}, padding:8, usePointStyle:true, pointStyleWidth:10 } } } } });
}
window.chartMode = m => { cMode = m; document.getElementById('cb-views').classList.toggle('on',m==='views'); document.getElementById('cb-hours').classList.toggle('on',m==='hours'); renderMonthly(); };

/* ‚îÄ‚îÄ main tabs ‚îÄ‚îÄ */
window.mainTab = function(t) {
    document.querySelectorAll('#main-tabs .tab').forEach(b=>b.classList.toggle('on', b.dataset.tab===t));
    document.getElementById('sec-personal').classList.toggle('vis', t==='personal');
    document.getElementById('sec-group').classList.toggle('vis', t==='group');
};

/* ‚îÄ‚îÄ group ‚îÄ‚îÄ */
function renderGroup() {
    const el = document.getElementById('group-root');
    if (!D.group) { el.innerHTML = '<div class="card"><div class="empty"><div class="empty-ico">üë•</div>–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –≥—Ä—É–ø–ø–µ</div></div>'; return; }
    const g = D.group, p = D.summary;

    const rows = [
        { lb:'üé¨ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã', y:p.total_views, gv:g.total_views },
        { lb:'üì∫ –≠–ø–∏–∑–æ–¥—ã',   y:p.total_episodes, gv:g.total_episodes },
        { lb:'üéûÔ∏è –§–∏–ª—å–º—ã',   y:p.total_movies, gv:g.total_movies },
        { lb:'üéØ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö',y:p.unique_shows, gv:g.unique_shows },
    ];
    let hasDiff = false;
    const cmpH = rows.map(r => {
        const d = r.y - r.gv;
        let dh;
        if (d===0) dh = '<span class="cmp-d d-eq">‚úÖ –ú—ç—Ç—á</span>';
        else { hasDiff = true; dh = `<span class="cmp-d ${d>0?'d-up':'d-dn'}">${d>0?'+':''}${d}</span>`; }
        return `<div class="cmp"><span class="cmp-lb">${r.lb}</span><div class="cmp-vs"><span class="cmp-v cmp-you">${r.y}</span><span style="color:var(--text-muted);font-size:10px">vs</span><span class="cmp-v cmp-grp">${r.gv}</span>${dh}</div></div>`;
    }).join('');

    const mx = Math.max(...g.members.map(m=>m.views),1);
    const mbH = g.members.map(m => `<div class="mb"><span class="mb-n">${m.name}</span><div class="mb-t"><div class="mb-f" style="width:${(m.views/mx)*100}%"></div></div><span class="mb-c">${m.views}</span></div>`).join('');

    let gGenH = '';
    if (g.genres?.length) {
        const gm = Math.max(...g.genres.map(x=>x.minutes),1);
        gGenH = '<div class="label">üé≠ –ñ–∞–Ω—Ä—ã –≥—Ä—É–ø–ø—ã</div><div class="card fu d3">' + g.genres.slice(0,5).map(x => {
            const w=(x.minutes/gm)*100, h=Math.floor(x.minutes/60), m=x.minutes%60;
            return `<div class="g-row"><div class="g-hdr"><span class="g-name">${x.name}</span><span class="g-time">${h}—á ${m}–º</span></div><div class="g-track"><div class="g-fill" style="width:${w}%;background:linear-gradient(90deg,#6887ff,#5bc0de)"></div></div></div>`;
        }).join('') + '</div>';
    }

    el.innerHTML = `
        <div class="card fu"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:20px">üë•</span><div><div style="font-size:15px;font-weight:700;color:var(--text-primary)">${g.group_name}</div><div style="font-size:11px;color:var(--text-muted)">${g.members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ¬∑ ${g.duration_display}</div></div></div></div>
        <div class="label">üìä –í—ã vs –ì—Ä—É–ø–ø–∞</div>
        <div class="card fu d1">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:11px;font-weight:700;color:var(--accent)">üë§ –í—ã</span><span style="font-size:11px;font-weight:700;color:var(--info)">üë• –ì—Ä—É–ø–ø–∞</span></div>
            ${!hasDiff?'<div style="text-align:center;padding:8px 0;font-size:13px;color:var(--accent);font-weight:600">‚úÖ –ü–æ–ª–Ω—ã–π –º—ç—Ç—á! –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>':''}
            ${cmpH}
        </div>
        <div class="label">üèÜ –£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div class="card fu d2">${mbH}</div>
        ${gGenH}`;
}

/* ‚îÄ‚îÄ init ‚îÄ‚îÄ */
load();
</script>
</body>
</html>
