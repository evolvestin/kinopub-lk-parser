services:
  init:
    image: busybox
    command: sh -c "mkdir -p /data && chown -R 1000:1000 /data"
    volumes:
      - ./data:/data

  web:
    build: .
    restart: unless-stopped
    env_file: .env
    ports:
      - "${WEB_PORT:-8012}:8000"
    volumes:
      - .:/app:delegated
      - ./data:/data
    command: >
      sh -c "
        python manage.py collectstatic --noinput &&
        if [ \"$ENVIRONMENT\" = \"DEV\" ]; then
          echo \"Dev environment detected. Starting restore from backup...\" &&
          python manage.py restorebackup;
        fi &&
        python manage.py migrate --noinput &&
        python manage.py createsuperuserifneeded &&
        if [ \"$DJANGO_DEBUG\" = \"true\" ] || [ \"$DJANGO_DEBUG\" = \"True\" ]; then
          echo \"Starting Django Development Server (ASGI)...\" &&
          python manage.py runserver 0.0.0.0:8000;
        else
          echo \"Starting Gunicorn (WSGI)...\" &&
          gunicorn kinopub_parser.wsgi:application --bind 0.0.0.0:8000 --workers 3 --threads 2;
        fi
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      init:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - kinopub-net

  asgi:
    build: .
    restart: unless-stopped
    env_file: .env
    ports:
      - "${ASGI_PORT:-8013}:8001"
    volumes:
      - .:/app:delegated
    command: daphne -b 0.0.0.0 -p 8001 kinopub_parser.asgi:application
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      web:
        condition: service_started
      redis:
        condition: service_started
    networks:
      - kinopub-net

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file: .env
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kinopub-net

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - kinopub-net

  celery:
    build: .
    command: celery -A kinopub_parser worker -l INFO
    restart: unless-stopped
    env_file: .env
    volumes:
      - .:/app:delegated
      - ./data:/data
    depends_on:
      init:
        condition: service_completed_successfully
      redis:
        condition: service_started
      db:
        condition: service_healthy
    networks:
      - kinopub-net
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f 'celery worker' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  celery-beat:
      build: .
      command: celery -A kinopub_parser beat -l INFO --schedule=/data/celerybeat-schedule
      restart: unless-stopped
      env_file: .env
      volumes:
        - .:/app:delegated
        - ./data:/data
      depends_on:
        init:
          condition: service_completed_successfully
        redis:
          condition: service_started
        db:
          condition: service_healthy
      networks:
        - kinopub-net
      healthcheck:
        test: [ "CMD-SHELL", "pgrep -f 'celery' || exit 1" ]
        interval: 30s
        timeout: 10s
        retries: 3

  email-listener:
    build: .
    command: python manage.py runemail_listener
    restart: unless-stopped
    env_file: .env
    volumes:
      - .:/app:delegated
    depends_on:
      db:
        condition: service_healthy
    networks:
      - kinopub-net
  
  telegram-bot:
    build:
      context: ./telegram_bot
    restart: unless-stopped
    env_file: .env
    environment:
      - BACKEND_URL=http://web:8000
    depends_on:
      web:
        condition: service_started
    volumes:
      - ./shared:/app/shared
      - ./telegram_bot:/app
    networks:
      - kinopub-net
  
  tunnel:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --url http://web:8000 --protocol http2
    profiles:
      - dev 
    networks:
      - kinopub-net
    depends_on:
      web:
        condition: service_started
  
  tunnel-monitor:
    build:
      context: ./tunnel_monitor
    profiles:
      - dev
    restart: unless-stopped
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - kinopub-net
    depends_on:
      telegram-bot:
        condition: service_started
      tunnel:
        condition: service_started

volumes:
  pgdata:
    name: ${PG_VOLUME_NAME:-kinopub_parser_pgdata}

networks:
  kinopub-net:
    driver: bridge